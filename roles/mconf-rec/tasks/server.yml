- name: Install nfs server
  become: yes
  apt:
    name: nfs-kernel-server

- name: Configure ufw rules for nfs
  become: yes
  ufw: rule=allow port=nfs src={{ hostvars[item].nfs_ip }}
  with_items: "{{ groups['mconf-recw'] }}"
  notify:
    - restart ufw

- name: Create sanity dir for recw
  become: yes
  file:
    path: /var/bigbluebutton/recording/status/sanity_{{ hostvars[item].nfs_name }}
    state: directory
    owner: tomcat7
    group: tomcat7
  with_items: "{{ groups['mconf-recw'] }}"

- name: Remove sanity dir
  become: yes
  file:
    path: /var/bigbluebutton/recording/status/sanity
    state: absent
  when: not mconf_rec_enable_local_processing

- name: Update exports
  become: yes
  template:
    src: files/exports.j2
    dest: /etc/exports
  notify: restart nfs-server

- name: Copy script to update mconf-decrypter.yml
  copy:
    src: files/update-mconf-decrypter.rb
    dest: /usr/local/bigbluebutton/core/scripts/utils/update-mconf-decrypter.rb
  become: yes
  when: mconf_rec_update_decrypter_enabled

- cron:
    name: update decrypter
    minute: 0
    hour: */4
    job: mysql -N -u {{ mconf_rec_update_decrypter_db_user }}-r -p'{{ mconf_rec_update_decrypter_db_password }}' -h {{ mconf_rec_update_decrypter_db_host }} -P {{ mconf_rec_update_decrypter_db_port }} {{ mconf_rec_update_decrypter_db_name }} -e "SELECT name, salt FROM Integrations JOIN Plans on Integrations.ownerId = Plans.id  WHERE ownerType = 'Plan' AND (expireAt IS NULL OR expireAt > now());" | ruby /usr/local/bigbluebutton/core/scripts/get-recordings.rb --api-server {{ mconf_rec_update_decrypter_api_server }} --rec-server {{ mconf_rec_update_decrypter_rec_server}}
    user: root
  become: yes
  when: mconf_rec_update_decrypter_enabled

- cron:
    name: cleanup published done
    special_time: daily
    job: mkdir -p /var/bigbluebutton/recording/status/old_published && find /var/bigbluebutton/recording/status/published/ -name "*.done" -mtime +30 -exec mv {} /var/bigbluebutton/recording/status/old_published/ \;
    user: root
  become: yes
