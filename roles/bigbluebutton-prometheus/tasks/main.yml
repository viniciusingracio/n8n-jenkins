---

- name: Update apt (if older than 60m)
  become: yes
  apt: update_cache=yes cache_valid_time=3600

- name: Install package for sponge
  become: yes
  apt:
    name: moreutils

- name: Create directories for scripts and results
  become: yes
  file:
    path: '{{ item }}'
    recurse: yes
    state: directory
  with_items:
    - /usr/local/etc/bigbluebutton-prometheus
    - /usr/local/share/prometheus

- name: Copy scripts
  become: yes
  synchronize:
    src: files/etc/
    dest: /usr/local/etc/bigbluebutton-prometheus/
    delete: yes

- name: Install cron job monitor metrics
  become: yes
  cron:
    name: bbb-prometheus-exporter
    job: /usr/bin/ruby /usr/local/etc/bigbluebutton-prometheus/bbb-prometheus-exporter.rb --ssl true | sponge /usr/local/share/prometheus/bbb-prometheus-exporter.prom
    user: root
- cron:
    name: bbb-prometheus-exporter-rec
    job: /usr/bin/ruby /usr/local/etc/bigbluebutton-prometheus/bbb-prometheus-exporter-rec.rb --ssl true | sponge /usr/local/share/prometheus/bbb-prometheus-exporter-rec.prom
    user: root
    minute: 0
    hour: '*/6'
  become: yes

- name: Install package for htpasswd
  become: yes
  apt:
    name: apache2-utils

- name: Check if bbb-web is running on a standalone app
  stat:
    path: /usr/share/bbb-web/WEB-INF/classes/bigbluebutton.properties
  register: reg_standalone
- set_fact:
    bigbluebutton_servlet_dir: /usr/share/bbb-web
  when: reg_standalone.stat.exists
- set_fact:
    bigbluebutton_servlet_dir: /var/lib/tomcat7/webapps/bigbluebutton
  when: not reg_standalone.stat.exists

- name: Get BigBlueButton secret
  shell: cat {{ bigbluebutton_servlet_dir }}/WEB-INF/classes/bigbluebutton.properties | grep '^securitySalt=' | cut -d'=' -f2  | hash('sha256')
  register: bbb_secret_raw
  when: bigbluebutton_prometheus_password is none

- set_fact:
    bigbluebutton_prometheus_password: '{{ bbb_secret_raw.stdout }}'
  when: bigbluebutton_prometheus_password is none

- name: Create password file
  become: yes
  shell: echo {{ bigbluebutton_prometheus_password }} | htpasswd -i -c /etc/apache2/.htpasswd prometheus

- name: Setup reverse proxy on nginx
  become: yes
  copy:
    src: files/node-exporter.nginx
    dest: /etc/bigbluebutton/nginx/node-exporter.nginx
  notify: reload nginx
