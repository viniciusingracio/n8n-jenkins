---

- name: Setup mtail config
  become: yes
  template:
    src: templates/bigbluebutton_nginx.mtail.j2
    dest: /usr/local/etc/bigbluebutton-prometheus/bigbluebutton_nginx.mtail
  notify: restart mtail exporter

- name: Start mtail exporter
  docker_container:
    name: mtail-exporter
    image: mconf/mtail:v3.0.0-rc36
    command: -logtostderr -progs /progs/bigbluebutton_nginx.mtail -logs /var/log/nginx/bigbluebutton.access.log
    pull: yes
    restart_policy: always
    volumes:
      - /usr/local/etc/bigbluebutton-prometheus/bigbluebutton_nginx.mtail:/progs/bigbluebutton_nginx.mtail
      - /var/log/nginx:/var/log/nginx
    ports:
      - 3903:3903
    labels:
      hostname: '{{ inventory_hostname }}'
    state: '{% if bigbluebutton_prometheus_mtail_exporter_enabled %}started{% else %}absent{% endif %}'
