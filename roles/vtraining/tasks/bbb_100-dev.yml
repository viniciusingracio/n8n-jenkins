- name: Install BigBlueButton dev dependencies
  become: yes
  apt:
    name: '{{ item }}'
    state: present
  with_items:
    - git-core
    - ant
    - openjdk-7-jdk

- name: Add dev tools to .bashrc
  blockinfile:
    dest: '{{ ansible_env.HOME }}/.bashrc'
    block: |
      export GRAILS_HOME=$HOME/dev/tools/grails
      export PATH=$PATH:$GRAILS_HOME/bin

      export FLEX_HOME=$HOME/dev/tools/flex
      export PATH=$PATH:$FLEX_HOME/bin

      export GRADLE_HOME=$HOME/dev/tools/gradle
      export PATH=$PATH:$GRADLE_HOME/bin

      export SBT_HOME=$HOME/dev/tools/sbt
      export PATH=$PATH:$SBT_HOME/bin

      export JAVA_HOME=/usr/lib/jvm/java-7-openjdk-amd64
      export ANT_OPTS="-Xmx512m -XX:MaxPermSize=768m"
    marker: '# {mark} ANSIBLE MANAGED BLOCK - bbb-dev'
    create: yes 

- file:
    path: "{{ ansible_env.HOME }}/dev/tools"
    state: directory
    mode: 0755

- unarchive:
    src: '{{ item.src }}'
    dest: '{{ ansible_env.HOME }}/dev/tools'
    remote_src: True
    creates: '{{ ansible_env.HOME }}/dev/tools/{{ item.creates }}'
  with_items:
    - { src: 'http://services.gradle.org/distributions/gradle-1.10-bin.zip', creates: 'gradle-1.10/bin/gradle' }
    - { src: 'http://dist.springframework.org.s3.amazonaws.com/release/GRAILS/grails-2.3.6.zip', creates: 'grails-2.3.6/bin/grails' }
    - { src: 'https://dl.bintray.com/sbt/native-packages/sbt/0.13.9/sbt-0.13.9.tgz', creates: 'sbt/bin/sbt' }
    - { src: 'https://archive.apache.org/dist/flex/4.13.0/binaries/apache-flex-sdk-4.13.0-bin.tar.gz', creates: 'apache-flex-sdk-4.13.0-bin/bin/mxmlc' }

- file:
    path: '{{ item }}'
    state: directory
    mode: 0755
  with_items:
    - '{{ ansible_env.HOME }}/dev/tools/apache-flex-sdk-4.13.0-bin/in'
    - '{{ ansible_env.HOME }}/dev/tools/apache-flex-sdk-4.13.0-bin/frameworks/libs/player/11.2'

- unarchive:
    src: http://download.macromedia.com/pub/flex/sdk/builds/flex4.6/flex_sdk_4.6.0.23201B.zip
    dest: '{{ ansible_env.HOME }}/dev/tools/apache-flex-sdk-4.13.0-bin/in'
    remote_src: True
    creates: '{{ ansible_env.HOME }}/dev/tools/apache-flex-sdk-4.13.0-bin/bin/mxmlc'

- name: Download swfobject
  get_url:
    url: https://github.com/swfobject/swfobject/archive/2.2.tar.gz
    dest: '{{ ansible_env.HOME }}/dev/tools/swfobject-2.2.tar.gz'
    mode: 0644

- name: Extract swfobject
  command: 'tar -xvf swfobject-2.2.tar.gz'
  args:
    chdir: '{{ ansible_env.HOME }}/dev/tools'
    creates: '{{ ansible_env.HOME }}/dev/tools/swfobject-2.2/swfobject/swfobject.js'

- name: Copy swfobject to flex
  command: cp -r '{{ ansible_env.HOME }}/dev/tools/swfobject-2.2/swfobject' '{{ ansible_env.HOME }}/dev/tools/apache-flex-sdk-4.13.0-bin/templates'
  args:
    creates: '{{ ansible_env.HOME }}/dev/tools/apache-flex-sdk-4.13.0-bin/templates/swfobject/swfobject.js'

- file:
    src: '{{ ansible_env.HOME }}/dev/tools/{{ item.src }}'
    dest: '{{ ansible_env.HOME }}/dev/tools/{{ item.dest }}'
    state: link
  with_items:
    - { src: 'gradle-1.10', dest: 'gradle' }
    - { src: 'grails-2.3.6', dest: 'grails' }
    - { src: 'apache-flex-sdk-4.13.0-bin', dest: 'flex' }

- name: Install Flex 3rd party tools
  command: "ant -f frameworks/build.xml -Dbuild.noprompt=true thirdparty-downloads"
  args:
    chdir: '{{ ansible_env.HOME }}/dev/tools/apache-flex-sdk-4.13.0-bin'
    creates: '{{ ansible_env.HOME }}/dev/tools/apache-flex-sdk-4.13.0-bin/in/osmf.swc'

- name: Download flash player
  get_url:
    url: http://fpdownload.macromedia.com/get/flashplayer/installers/archive/playerglobal/playerglobal11_2.swc
    dest: '{{ ansible_env.HOME }}/dev/tools/apache-flex-sdk-4.13.0-bin/frameworks/libs/player/11.2/playerglobal.swc'
    mode: 0644

- name: Adjust permissions and versions on flex
  shell: |
    find -type d -exec chmod o+rx '{}' \;
    chmod 755 bin/*
    chmod -R +r .
    sed -i "s/11.1/11.2/g" frameworks/flex-config.xml
    sed -i "s/<swf-version>14<\/swf-version>/<swf-version>15<\/swf-version>/g" frameworks/flex-config.xml
    sed -i "s/{playerglobalHome}\/{targetPlayerMajorVersion}.{targetPlayerMinorVersion}/libs\/player\/11.2/g" frameworks/flex-config.xml
  args:
    chdir: '{{ ansible_env.HOME }}/dev/tools/apache-flex-sdk-4.13.0-bin'
