- name: Install Kurento dependencies
  become: yes
  apt:
    name: '{{ item }}'
    state: present
  with_items:
    - git-core
    - monit
    - build-essential

- name: Add Kurento apt key
  become: yes
  apt_key:
    url: "http://ubuntu.kurento.org/kurento.gpg.key"
    state: present
  register: aptkey

- name: Add Kurento repo to apt
  become: yes
  apt_repository:
    repo: '{{ item }}'
    state: present
  register: aptrepos
  with_items:
    - 'deb http://ubuntu.kurento.org {{ ansible_distribution_release }} kms6'

- name: Update apt if keys changed
  become: yes
  apt: update_cache=yes
  when: aptkey|changed or aptrepos|changed

- name: Install Kurento
  become: yes
  apt:
    name: '{{ item }}'
    state: present
  with_items:
    - kurento-media-server-6.0
    - openh264-gst-plugins-bad-1.5
    - gnutls-bin

- service:
    name: kurento-media-server-6.0
    # not sure why pattern is necessary
    pattern: kurento-media-server-6.0
    state: started
    enabled: yes
  become: yes

- file:
    path: "/etc/kurento/certs"
    state: directory
    mode: 0755
  become: yes

- file:
    path: '{{ item }}'
    state: absent
  become: yes
  with_items:
    - /etc/kurento/certs/server.crt
    - /etc/kurento/certs/server.key

- file:
    src: '{{ item.src }}'
    dest: '{{ item.dest }}'
    state: link
  become: yes
  with_items:
    - { src: '{{ ssl_certificate }}', dest: '/etc/kurento/certs/server.crt' }
    - { src: '{{ ssl_certificate_key }}', dest: '/etc/kurento/certs/server.key' }
# 
# - name: Generate certificate
#   command: 'openssl x509 -inform DER -in /etc/nginx/certs/{{ ssl_certificate }} -out /etc/kurento/certs/server.pem -text'
#   become: yes

# - name:
#   become: yes
#   command: certtool --generate-privkey --outfile /etc/kurento/certs/key.pem
#   args:
#     creates: "/etc/kurento/certs/key.pem"
# 
# - copy:
#     src: files/certtool.tmpl
#     dest: /etc/kurento/certs/
#     mode: 0644
#   become: yes
# 
# - name:
#   command: certtool --generate-self-signed --load-privkey /etc/kurento/certs/key.pem --template /etc/kurento/certs/certtool.tmpl --outfile /etc/kurento/certs/certificate.pem
#   args:
#     creates: /etc/kurento/certs/certificate.pem
#   become: yes

- copy:
    src: files/kurento.conf.json
    dest: /etc/kurento/kurento.conf.json
    owner: root
    group: root
    mode: '0644'
    backup: yes
  become: yes
  notify: restart redis-server

- cron:
    name: "Report"
    minute: "55"
    hour: "1"
    job: "/usr/local/bin/slack/run-report.sh"

- cron:
    name: "Restart Kurento"
    minute: "0"
    hour: "2"
    job: "/usr/sbin/service kurento-media-server-6.0 force-stop"
