- git:
    repo: git@github.com:mconf/bigbluebutton-cs.git
    dest: '{{ ansible_env.HOME }}/dev/bigbluebutton'
    version: 10beta-kurento-vtraining
    accept_hostkey: true
    update: false

# TODO use find instead of shell
- name:
  shell: |
    sed -i 's|\(version := \)".*|\1"0.0.19-SNAPSHOT"|g' bbb-common-message/build.sbt
    find -name build.gradle -exec sed -i "s|\(.*org.bigbluebutton.*bbb-common-message\):.*|\1:0.0.19-SNAPSHOT'|g" {} \;
    find -name build.sbt -exec sed -i 's|\(.*org.bigbluebutton.*bbb-common-message"[ ]*%[ ]*\)"[^"]*"\(.*\)|\1"0.0.19-SNAPSHOT"\2|g' {} \;

    sed -i 's|\(version := \)".*|\1"0.0.4-SNAPSHOT"|g' bbb-fsesl-client/build.sbt
    find -name build.sbt -exec sed -i 's|\(.*org.bigbluebutton.*bbb-fsesl-client"[ ]*%[ ]*\)"[^"]*"\(.*\)|\1"0.0.4-SNAPSHOT"\2|g' {} \;

    sed -i 's|\(version := \)".*|\1"0.0.2-SNAPSHOT"|g' akka-bbb-transcode/build.sbt
    find -name build.gradle -exec sed -i "s|\(.*org.bigbluebutton.*bbb-transcode-akka\):.*|\1:0.0.2-SNAPSHOT'|g" {} \;
    find -name build.sbt -exec sed -i 's|\(.*org.bigbluebutton.*bbb-transcode-akka"[ ]*%[ ]*\)"[^"]*"\(.*\)|\1"0.0.2-SNAPSHOT"\2|g' {} \;

    sed -i 's|javax/media|javax.media|g' bbb-voice/build.gradle
  args:
    chdir: '{{ ansible_env.HOME }}/dev/bigbluebutton'

- name: Stop BigBlueButton
  command: bbb-conf --stop
  become: yes
  notify: restart bigbluebutton

- include: bbb_100-build-akka-apps.yml
  tags: [build-bbb,build-akka-apps]

- include: bbb_100-build-red5-apps.yml
  tags: [build-bbb,build-red5-apps]

- include: bbb_100-build-flash.yml
  tags: [build-bbb,build-flash]

- include: bbb_100-build-web.yml
  tags: [build-bbb,build-web]

- name: Deploy bbb-conf and bbb-record
  copy:
    src: '{{ item }}'
    dest: '/usr/bin/'
    mode: 0755
    remote_src: true
  become: yes
  with_fileglob:
    - '{{ ansible_env.HOME }}/dev/bigbluebutton-config/bin/*'

- name: Adjust sip.nginx
  become: yes
  lineinfile:
    dest: '/etc/bigbluebutton/nginx/sip.nginx'
    state: present
    regexp: '{{ item.regexp }}'
    line: '{{ item.line }}'
  with_items:
    - { regexp: '^location\s', line: 'location /ws {' }
    - { regexp: '^\s*proxy_pass\s', line: '        proxy_pass https://{{ ansible_default_ipv4.address }}:7443;' }
  tags: [nginx,nginx-bbb]

- name: Adjust web.nginx
  become: yes
  lineinfile:
    dest: /etc/bigbluebutton/nginx/web
    state: present
    regexp: '{{ item.regexp }}'
    line: '{{ item.line }}'
  with_items:
    - { regexp: '^\s*location.*/bigbluebutton', line: '       location /bigbluebutton {' }
    - { regexp: '^\s*proxy_pass\s*http://127.0.0.1:8080', line: '           proxy_pass         http://127.0.0.1:8080/bigbluebutton;' }
  tags: [nginx,nginx-bbb]

# TODO not working yet
# - name: Adjust web.nginx part 2
#   blockinfile:
#     dest: /etc/bigbluebutton/nginx/web
#     block: |
#            proxy_cookie_path /bigbluebutton /live/bigbluebutton;
#     insertafter: 'proxy_set_header'
#     marker: '# {mark} ANSIBLE MANAGED BLOCK'
#     create: yes
#   become: yes
#   tags: [nginx,nginx-bbb]
