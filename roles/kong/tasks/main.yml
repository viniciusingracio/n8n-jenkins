- name: Create a temporary folder
  tempfile:
    state: directory
    suffix: temp
  register: temp_config

- name: Copy the Dockerfile to build Kong
  become: yes
  copy:
    src: 'files/Dockerfile'
    dest: '{{ temp_config.path }}/Dockerfile'

- name: Save Kong's configuration file
  become: yes
  template:
    src: kong-declarative.yml.j2
    dest: '{{ temp_config.path }}/kong-declarative.yaml'

- name: Build the docker image
  docker_image:
    build:
      path: '{{ temp_config.path }}'
      pull: no
    source: build
    force_source: yes
    name: '{{ kong_image_name }}'
    tag: '{{ kong_image_tag }}'

- name: Start the container
  docker_container:
    name: '{{ kong_image_name }}'
    image: '{{ kong_image_name }}:{{ kong_image_tag }}'
    restart_policy: always
    published_ports:
      - '{{ kong_port }}:8000'
      - '{{ kong_admin_port }}:8001'
    detach: true
