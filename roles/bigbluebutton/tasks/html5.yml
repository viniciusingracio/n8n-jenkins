- name: Add mongo apt key
  become: true
  apt_key:
    keyserver: keyserver.ubuntu.com
    id: 0C49F3730359A14518585931BC711F9BA15703C6
    state: present
  register: aptkey

- name: Add mongo repo to apt
  become: true
  apt_repository:
    repo: 'deb [ arch=amd64,arm64 ] http://repo.mongodb.org/apt/ubuntu xenial/mongodb-org/3.4 multiverse'
    state: present
  register: aptrepos

- name: Update apt if keys changed
  become: true
  apt: update_cache=yes
  when: aptkey is changed or aptrepos is changed

- name: Install mongo
  become: true
  apt:
    name: mongodb-org
    state: '{{ bigbluebutton_apt_state }}'
  notify: start mongo

- name: Install hmtl5 client
  become: true
  apt:
    name: 'bbb-html5'
    state: '{{ bigbluebutton_apt_state }}'
  notify: restart bigbluebutton

- include: json-deps.yml

- name: Update json values
  become: true
  json:
    path: /usr/share/meteor/bundle/programs/server/assets/app/config/settings-production.json
    replace:
      json_path: '{{ item.path }}'
      with_value: '{{ item.value }}'
    indent: 4
    insert_if_missing: true
  ignore_errors: yes
  with_items: '{{ bigbluebutton_html5_config }}'
  notify: restart bbb-html5

- name: Set default guest policy on bigbluebutton.properties
  become: yes
  replace:
    path: /var/lib/tomcat7/webapps/bigbluebutton/WEB-INF/classes/bigbluebutton.properties
    regexp: '^defaultGuestPolicy=.*'
    replace: 'defaultGuestPolicy=ALWAYS_ACCEPT'
    encoding: '{{ properties_charset }}'
  notify: restart bigbluebutton
