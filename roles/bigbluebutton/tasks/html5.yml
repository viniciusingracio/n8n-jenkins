- name: Add mongo apt key
  become: true
  apt_key:
    keyserver: keyserver.ubuntu.com
    id: 0C49F3730359A14518585931BC711F9BA15703C6
    state: present
  register: aptkey

- name: Add mongo repo to apt
  become: true
  apt_repository:
    repo: 'deb [ arch=amd64,arm64 ] http://repo.mongodb.org/apt/ubuntu xenial/mongodb-org/3.4 multiverse'
    state: present
  register: aptrepos

- name: Update apt if keys changed
  become: true
  apt: update_cache=yes
  when: aptkey is changed or aptrepos is changed

- name: Install mongo
  become: true
  apt:
    name: mongodb-org
    state: '{{ bigbluebutton_apt_state }}'
  notify: start mongo

- name: Install hmtl5 client
  become: true
  apt:
    name: 'bbb-html5'
    state: '{{ bigbluebutton_apt_state }}'
  notify: restart bigbluebutton

- include: json-deps.yml

- set_fact:
    bigbluebutton_html5_config: "{{ bigbluebutton_html5_config + [ item ] }}"
  with_items:
    - { path: '/public/clientLog/external/enabled', value: '{{ bigbluebutton_html5_external_log_enabled }}' }
    - { path: '/public/clientLog/external/level', value: '{{ bigbluebutton_html5_external_log_level }}' }
    - { path: '/public/clientLog/external/url', value: '{{ bigbluebutton_html5_external_log_url }}' }
    - { path: '/public/clientLog/external/method', value: '{{ bigbluebutton_html5_external_log_method }}' }

- name: Update json values
  become: true
  json:
    path: /usr/share/meteor/bundle/programs/server/assets/app/config/settings-production.json
    replace:
      json_path: '{{ item.path }}'
      with_value: '{{ item.value }}'
    indent: 4
    insert_if_missing: true
  ignore_errors: yes
  with_items: '{{ bigbluebutton_html5_config }}'
  notify: restart bbb-html5

- name: Install full nginx
  become: yes
  apt:
    name: nginx-full
    state: '{{ bigbluebutton_apt_state }}'
  when: bigbluebutton_html5_external_log_enabled
  notify: restart nginx

- name: Setup external log on nginx
  become: yes
  copy:
    src: '{{ item.src }}'
    dest: '{{ item.dest }}'
  with_items:
    - { src: 'files/client-log.nginx', dest: '/etc/bigbluebutton/nginx/client-log.nginx' }
    - { src: 'files/client-log.conf', dest: '/etc/nginx/conf.d/client-log.conf' }
  when: bigbluebutton_html5_external_log_enabled
  notify: reload nginx

- name: Configure log file
  become: yes
  file:
    path: /var/log/nginx/html5-client.log
    owner: www-data
    group: adm
    mode: 0640
    state: touch
  when: bigbluebutton_html5_external_log_enabled

- name: Remove nginx entry when external log is disabled
  become: yes
  file:
    path: /etc/bigbluebutton/nginx/client-log.nginx
    state: absent
  when: not bigbluebutton_html5_external_log_enabled
  notify: reload nginx

- name: Set bigbluebutton.properties
  become: yes
  replace:
    path: /var/lib/tomcat7/webapps/bigbluebutton/WEB-INF/classes/bigbluebutton.properties
    regexp: '{{ item.regexp }}'
    replace: '{{ item.replace }}'
    encoding: '{{ properties_charset }}'
  with_items:
    - { regexp: '^defaultGuestPolicy=.*', replace: 'defaultGuestPolicy=ALWAYS_ACCEPT' }
    - { regexp: '^svgImagesRequired=.*', replace: 'svgImagesRequired=True' }
  notify: restart bigbluebutton
