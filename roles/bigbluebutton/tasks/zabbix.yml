- name: Copy scripts
  synchronize:
    src: files/zabbix/
    dest: /etc/zabbix/scripts/
    delete: yes
    # TODO do not remove node_modules
    # rsync_opts:
    #   - --filter='P */node_modules/*'
  become: yes

- name: Set owner of zabbix scripts dir
  file:
    path: /etc/zabbix/scripts/
    recurse: yes
    state: directory
    owner: '{{ deploy_user }}'
    group: '{{ deploy_user }}'
  become: yes

- find:
    paths: /etc/zabbix/scripts/
    patterns: setup.sh
    recurse: yes
  register: find_result

- name: Setup
  command: '{{ item.path }}'
  with_items: '{{ find_result.files }}'

- name: Userparams
  shell: find /etc/zabbix/scripts/ -name userparams.conf -exec cat {} \; | tee /etc/zabbix/zabbix_agentd.d/userparams_mconf.conf
  become: yes
  notify: restart zabbix-agent

- name: Copy sudoers
  copy:
    src: files/zabbix/zabbix.sudoers
    dest: /etc/sudoers.d/zabbix
    owner: root
    group: root
    mode: 0440
    validate: /usr/sbin/visudo -cf %s
  become: yes
  notify: restart zabbix-agent 
