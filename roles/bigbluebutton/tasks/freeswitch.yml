- name: Determine wss_binding value
  set_fact:
    wss_binding_value: '{% if ansible_default_ipv4.address == external_ip %}:7443{% else %}{{ external_ip }}:7443{% endif %}'
    ws_binding_value: :5066

- name: Define FreeSWITCH external SIP port
  set_fact:
    freeswitch_sip_port: '{% if bigbluebutton_sip %}5062{% else %}5060{% endif %}'

- name: Modify FreeSWITCH SIP port
  xml:
    path: /opt/freeswitch/conf/vars.xml
    xpath: '{{ item.xpath }}'
    attribute: '{{ item.attribute }}'
    value: '{{ item.value }}'
  with_items:
    - { xpath: '//X-PRE-PROCESS[@cmd="set" and starts-with(@data, "external_sip_port=")]', attribute: 'data', value: 'external_sip_port={{ freeswitch_sip_port }}' }
  become: yes
  register: modify_sip_port

- name: Restart FreeSWITCH
  become: yes
  systemd:
    name: freeswitch
    state: restarted
  when: modify_sip_port is changed

- name: Modify FreeSWITCH vars.xml
  xml:
    path: /opt/freeswitch/conf/vars.xml
    xpath: '{{ item.xpath }}'
    attribute: '{{ item.attribute }}'
    value: '{{ item.value }}'
  with_items:
    - { xpath: '//X-PRE-PROCESS[@cmd="set" and starts-with(@data, "external_rtp_ip=")]', attribute: 'data', value: 'external_rtp_ip={{ external_ip }}' }
    - { xpath: '//X-PRE-PROCESS[@cmd="set" and starts-with(@data, "external_sip_ip=")]', attribute: 'data', value: 'external_sip_ip={{ external_ip }}' }
    - { xpath: '//X-PRE-PROCESS[@cmd="set" and starts-with(@data, "sound_prefix=")]', attribute: 'data', value: 'sound_prefix={{ bigbluebutton_sounds_prefix }}' }
    - { xpath: '//X-PRE-PROCESS[@cmd="set" and starts-with(@data, "local_ip_v4=")]', attribute: 'data', value: 'local_ip_v4={{ ansible_default_ipv4.address }}' }
  become: yes
  notify: restart bigbluebutton

- name: Determine properties to modify external.xml
  set_fact:
    external_props: 
      - { name: "ext-rtp-ip", value: '$${external_rtp_ip}' }
      - { name: "ext-sip-ip", value: '$${external_sip_ip}' }
      - { name: "ws-binding", value: "{{ ws_binding_value }}" }
      - { name: "wss-binding", value: "{{ wss_binding_value }}" }
      - { name: "apply-candidate-acl", value: "0.0.0.0/0" }

- name: Read external_props
  xml:
    path: /opt/freeswitch/conf/sip_profiles/external.xml
    xpath: /profile/settings/param[@name="{{ item.name }}"]
    content: attribute
    attribute: value
  with_items: '{{ external_props }}'
  register: external_props_read
  ignore_errors: yes
  become: yes

- name: Add external_prop if it doesn't exist
  xml:
    path: /opt/freeswitch/conf/sip_profiles/external.xml
    xpath: /profile/settings
    add_children:
      - param:
          name: '{{ item.item.name }}'
          value: '{{ item.item.value }}'
    pretty_print: yes
  with_items: '{{ external_props_read.results }}'
  when: item is failed
  become: yes
  notify: restart bigbluebutton

- name: Modify external_prop if it exists
  xml:
    path: /opt/freeswitch/conf/sip_profiles/external.xml
    xpath: /profile/settings/param[@name="{{ item.item.name }}"]
    attribute: value
    value: '{{ item.item.value }}'
  with_items: '{{ external_props_read.results }}'
  when: item is succeeded
  become: yes
  notify: restart bigbluebutton

- name: Modify external_sip_port on bbb-voice
  lineinfile:
    dest: /usr/share/red5/webapps/sip/WEB-INF/bigbluebutton-sip.properties
    state: present
    regexp: ^freeswitch\.port=
    line: 'freeswitch.port={{ freeswitch_sip_port }}'
  become: yes
  notify: restart bigbluebutton

- name: Read rtp range attributes attribute
  xml:
    path: /opt/freeswitch/conf/autoload_configs/switch.conf.xml
    xpath: '{{ item.xpath }}'
    content: attribute
    attribute: value
  with_items:
    - { xpath: '/configuration/settings/param[@name="rtp-start-port"]', name: 'rtp-start-port', value: '{{ bigbluebutton_freeswitch_udp_range_begin }}' }
    - { xpath: '/configuration/settings/param[@name="rtp-end-port"]', name: 'rtp-end-port', value: '{{ bigbluebutton_freeswitch_udp_range_end }}' }
  register: hits
  ignore_errors: yes
  become: yes

- name: Modify rtp range if it exists
  xml:
    path: /opt/freeswitch/conf/autoload_configs/switch.conf.xml
    xpath: '{{ item.item.xpath }}'
    attribute: value
    value: '{{ item.item.value }}'
  with_items: '{{ hits.results }}'
  become: yes
  when: item is succeeded
  notify: restart bigbluebutton

- name: Add rtp range if it doesn't exist
  xml:
    path: /opt/freeswitch/conf/autoload_configs/switch.conf.xml
    xpath: '/configuration/settings'
    add_children:
      - param:
          name: '{{ item.item.name }}'
          value: '{{ item.item.value }}'
    pretty_print: yes
  with_items: '{{ hits.results }}'
  become: yes
  when: item is failed
  notify: restart bigbluebutton

- name: Check if IPv6 is supported
  shell: ip addr | grep inet6
  ignore_errors: yes
  register: reg_ipv6

- name: Change listen-ip on the socket layer since it can't handle IPv6
  become: yes
  xml:
    path: /opt/freeswitch/etc/freeswitch/autoload_configs/event_socket.conf.xml
    xpath: //param[@name="listen-ip"]
    attribute: value
    value: '127.0.0.1'
  when: reg_ipv6 is failed
  notify: restart bigbluebutton

- name: Remove IPv6 configuration from FreeSWITCH profiles
  become: yes
  command: mv {{ item }} {{ item }}_
  args:
    creates: '{{ item }}_'
    removes: '{{ item }}'
  with_items:
    - /opt/freeswitch/etc/freeswitch/sip_profiles/internal-ipv6.xml
    - /opt/freeswitch/etc/freeswitch/sip_profiles/external-ipv6.xml
  when: reg_ipv6 is failed
  notify: restart bigbluebutton

- include: sounds.yml
