- name: Install mcs-sip
  become: true
  apt:
    name: 'mconf-mcs-sip'
    state: '{{ bigbluebutton_apt_state }}'
  notify: restart bigbluebutton

- include: json-deps.yml

- name: Update config
  become: true
  json:
    path: /usr/local/bigbluebutton/mconf-mcs-sip/config/default.json
    replace:
      json_path: '{{ item.path }}'
      with_value: '{{ item.value }}'
    indent: 4
    insert_if_missing: true
  with_items:
    - { path: '/kurento/server/ip_address', value: '{{ external_ip }}' }
    - { path: '/sip/local_ip_address', value: '{{ external_ip }}' }
    - { path: '/sip/min_video_port', value: '{{ bigbluebutton_sip_udp_range_begin }}' }
    - { path: '/sip/max_video_port', value: '{{ bigbluebutton_sip_udp_range_end }}' }
    - { path: '/sip/default_gateway', value: '{{ bigbluebutton_sip_default_gateway | default("GATEWAY", true) }}' }
    - { path: '/conference-media-specs/mconf_main_inbound_codec', value: 'libx264' }
  notify: restart mconf-mcs-sip
