- name: Landing page
  unarchive:
    src: 'envs/{{ env }}/files/index.tar.gz'
    dest: /var/www/bigbluebutton-default
  become: yes

- name: Figure out which demo to use
  set_fact:
    demo_jsp: '{% if bigbluebutton_html5 %}demoHTML5{% else %}demo0{% endif %}'

- name: Set demo to use the HTML5 client
  replace:
    path: '/var/www/bigbluebutton-default/index.html'
    regexp: '(?P<before><form [^>]*)\/demo\/.*.jsp(?P<after>[^>]*>)'
    replace: '\g<before>/demo/{{ demo_jsp }}.jsp\g<after>'
  become: yes
  when: bigbluebutton_demos

- name: Copy layout.xml
  copy:
    src: '{{ bigbluebutton_branding_layout }}'
    dest: /var/www/bigbluebutton/client/conf/layout.xml
  become: yes
  when: not((bigbluebutton_branding_layout is undefined) or (bigbluebutton_branding_layout is none) or (bigbluebutton_branding_layout | trim == ''))

- name: Copy client logo
  copy:
    src: '{{ bigbluebutton_branding_logo_client }}'
    dest: /var/www/bigbluebutton/client/logo.png
  become: yes
  when: not((bigbluebutton_branding_logo_client is undefined) or (bigbluebutton_branding_logo_client is none) or (bigbluebutton_branding_logo_client | trim == ''))

- name: Copy playback logo
  copy:
    src: '{{ bigbluebutton_branding_logo_playback }}'
    dest: '{{ item }}'
  with_items:
    - /var/bigbluebutton/playback/presentation/0.81/logo.png
    - /var/bigbluebutton/playback/presentation/0.9.0/logo.png
    - /var/bigbluebutton/playback/presentation_export/logo.png
  ignore_errors: yes
  become: yes
  when: not((bigbluebutton_branding_logo_playback is undefined) or (bigbluebutton_branding_logo_playback is none) or (bigbluebutton_branding_logo_playback | trim == ''))

- name: Customize HTML5 Client title
  replace:
    path: /usr/share/meteor/bundle/programs/web.browser/head.html
    regexp: '(<title>)[^<]*'
    replace: '\1Mconf-Live HTML5'
  become: yes
  when: bigbluebutton_html5

- name: Customize HTML5 app properties
  replace:
    path: /usr/share/meteor/bundle/programs/server/assets/app/config/public/app.yaml
    regexp: '{{ item.regexp }}'
    replace: '{{ item.replace }}'
  with_items:
    - { regexp: '(^[ \t]*appName): .*', replace: '\1: Mconf-Live HTML5' }
    - { regexp: '(^[ \t]*copyright): .*', replace: '\1: {{ bigbluebutton_branding_copyright_html5 }}' }
  become: yes
  when: bigbluebutton_html5
  notify: restart bbb-html5

- name: Customize error message on playback
  replace:
    path: /var/bigbluebutton/playback/presentation/0.9.0/playback.html
    regexp: '(<p id="load-error-msg">)[^<]*'
    replace: '\1{{ bigbluebutton_branding_playback_error }}'
  become: yes

- name: Customize page title on playback
  replace:
    path: /var/bigbluebutton/playback/presentation/0.9.0/lib/writing.js
    regexp: '(    document.title =) "[^"]*";'
    replace: '\1 "{{ bigbluebutton_branding_playback_title }}";'
  become: yes

- name: Customize copyright on playback
  replace:
    path: /var/bigbluebutton/playback/presentation/0.9.0/playback.js
    regexp: '(  copyright = typeof copyright !== ''undefined'' \? copyright :) ''[^'']*'';'
    replace: '\1 ''{{ bigbluebutton_branding_playback_copyright }}'';'
  become: yes

- name: Create temporary directory for bbb-client
  tempfile:
    state: directory
  register: tmpdir_client

- name: Download bbb-client from repo
  command: apt-get download bbb-client
  args:
    chdir: '{{ tmpdir_client.path }}'

- name: Reset config.xml
  shell: 'dpkg-deb --fsys-tarfile {{ tmpdir_client.path }}/bbb-client_*.deb | tar -x ./var/www/bigbluebutton/client/conf/config.xml --strip-components=6'
  args:
    chdir: '{{ tmpdir_client.path }}'

- replace:
    path: '{{ tmpdir_client.path }}/config.xml'
    regexp: '{{ item.regexp }}'
    replace: '{{ item.replace }}'
  with_items:
    - { regexp: 'http:\/\/HOST', replace: 'https://HOST' }
    - { regexp: 'HOST', replace: '{{ inventory_hostname }}' }

- name: Customize config.xml
  xml:
    path: '{{ tmpdir_client.path }}/config.xml'
    xpath: '{{ item.xpath }}'
    attribute: '{{ item.attribute }}'
    value: '{{ item.value }}'
  with_items:
    - { xpath: '/config/branding', attribute: 'logo', value: 'logo.png' }
    - { xpath: '/config/branding', attribute: 'copyright', value: '{{ bigbluebutton_branding_copyright }}' }
    - { xpath: '/config/branding', attribute: 'toolbarColor', value: '{{ bigbluebutton_branding_toolbar_color }}' }
    - { xpath: '/config/branding', attribute: 'toolbarColorAlphas', value: '{{ bigbluebutton_branding_toolbar_color_alphas }}' }
    - { xpath: '/config/mconfDeskshare', attribute: 'downloadLinkWindows', value: '{{ bigbluebutton_branding_deskshare_windows }}' }
    - { xpath: '/config/mconfDeskshare', attribute: 'downloadLinkMacOS', value: '{{ bigbluebutton_branding_deskshare_mac }}' }
    - { xpath: '//module[@name="PhoneModule"]', attribute: 'showWebRTCStats', value: 'true' }

- name: Copy temporary config.xml to client dir
  copy:
    src: '{{ tmpdir_client.path }}/config.xml'
    dest: /var/www/bigbluebutton/client/conf/config.xml
    remote_src: yes
  become: yes
  notify: restart bigbluebutton

- name: Remove temporary directory for bbb-client
  file:
    path: '{{ tmpdir_client }}'
    state: absent

- name: Create link to Mconf-Live.html
  file:
    src: /var/www/bigbluebutton/client/BigBlueButton.html
    dest: /var/www/bigbluebutton/client/Mconf-Live.html
    state: link
  become: yes

- name: Customize bigbluebutton.properties
  replace:
    path: /var/lib/tomcat7/webapps/bigbluebutton/WEB-INF/classes/bigbluebutton.properties
    regexp: '{{ item.regexp }}'
    replace: '{{ item.replace }}'
    # UTF-8 fails to set accent words properly
    encoding: iso-8859-1
  with_items:
    - { regexp: '^(defaultWelcomeMessage)=.*', replace: '\1={{ bigbluebutton_branding_welcome }}' }
    - { regexp: '^(defaultWelcomeMessageFooter)=.*', replace: '\1={{ bigbluebutton_branding_welcome_footer }}' }
    - { regexp: '^(defaultClientUrl)=.*', replace: '\1=${bigbluebutton.web.serverURL}/client/Mconf-Live.html' }
  become: yes
  notify: restart bigbluebutton

- name: Customize blinker
  replace:
    path: /var/www/bigbluebutton/client/lib/bbb_blinker.js
    regexp: '"BigBlueButton - " \+ title'
    replace: 'title'
  become: yes

# TODO sons do FreeSWITCH
# TODO gravação em todas as salas
