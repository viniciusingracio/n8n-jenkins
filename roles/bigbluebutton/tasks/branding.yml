- name: Landing page
  synchronize:
    src: envs/{{ env }}/files/landing_page/
    dest: /var/www/bigbluebutton-default
    use_ssh_args: yes
  become: yes
  ignore_errors: yes

- name: Set demo to use the HTML5 client
  replace:
    path: '/var/www/bigbluebutton-default/index.html'
    regexp: '(?P<before><form [^>]*)\/demo\/.*.jsp(?P<after>[^>]*>)'
    replace: '\g<before>/demo/demo0.jsp\g<after>'
  become: yes
  when: bigbluebutton_demos|bool

- name: Copy layout.xml
  copy:
    src: '{{ bigbluebutton_branding_layout }}'
    dest: /var/www/bigbluebutton/client/conf/layout.xml
  become: yes
  when: not bigbluebutton_branding_layout is none and not bigbluebutton_html5_only|bool

- name: Copy client logo
  copy:
    src: '{{ bigbluebutton_branding_logo_client }}'
    dest: /var/www/bigbluebutton/client/logo.png
  become: yes
  when: not bigbluebutton_branding_logo_client is none and not bigbluebutton_html5_only|bool

- name: Copy playback logo
  copy:
    src: '{{ bigbluebutton_branding_logo_playback }}'
    dest: '{{ item }}'
  with_items:
    - /var/bigbluebutton/playback/presentation/0.81/logo.png
    - /var/bigbluebutton/playback/presentation/0.9.0/logo.png
    - /var/bigbluebutton/playback/presentation/2.0/logo.png
  ignore_errors: yes
  become: yes
  when: not bigbluebutton_branding_logo_playback is none

- name: Customize error message on playback
  replace:
    path: '{{ item }}'
    regexp: '(  document.getElementById\("load-msg"\)\.innerHTML =).*;'
    replace: '\1 "{{ bigbluebutton_branding_playback_error }}";'
  ignore_errors: yes
  become: yes
  when: not bigbluebutton_branding_playback_error is none
  with_items:
    - /var/bigbluebutton/playback/presentation/0.9.0/lib/writing.js
    - /var/bigbluebutton/playback/presentation/2.0/lib/writing.js

- name: Customize loading message on playback
  replace:
    path: '{{ item }}'
    regexp: '(<p id="load-msg">)[^<]*'
    replace: '\1{{ bigbluebutton_branding_playback_loading }}'
  ignore_errors: yes
  become: yes
  when: not bigbluebutton_branding_playback_loading is none
  with_items:
    - /var/bigbluebutton/playback/presentation/0.9.0/playback.html
    - /var/bigbluebutton/playback/presentation/2.0/playback.html

- name: Customize page title on playback
  replace:
    path: '{{ item }}'
    regexp: '(  document.title =) "[^"]*";'
    replace: '\1 "{{ bigbluebutton_branding_playback_title }}";'
  ignore_errors: yes
  become: yes
  when: not bigbluebutton_branding_playback_title is none
  with_items:
    - /var/bigbluebutton/playback/presentation/0.9.0/lib/writing.js
    - /var/bigbluebutton/playback/presentation/2.0/lib/writing.js

- name: Customize copyright on playback
  replace:
    path: '{{ item }}'
    regexp: '(const defaultCopyright =).*;'
    replace: '\1 ''{{ bigbluebutton_branding_playback_copyright }}'';'
  ignore_errors: yes
  become: yes
  when: not bigbluebutton_branding_playback_copyright is none
  with_items:
    - /var/bigbluebutton/playback/presentation/0.9.0/playback.js
    - /var/bigbluebutton/playback/presentation/2.0/playback.js

- name: Check if video recorder is present
  stat:
    path: /usr/local/bigbluebutton/core/scripts/record/video_recorder.rb
  register: reg_recorder

- name: Customize page title
  replace:
    path: /usr/local/bigbluebutton/core/scripts/record/video_recorder.rb
    regexp: '([\t ]+playback_window_title =).*'
    replace: '\1 "{{ bigbluebutton_branding_playback_title }}"'
  become: yes
  when: reg_recorder.stat.exists and not bigbluebutton_branding_playback_title is none

- name: Customize copyright on playback
  replace:
    path: '{{ item }}'
    regexp: '(  copyright = typeof copyright !== ''undefined'' \? copyright :) ''[^'']*'';'
    replace: '\1 ''{{ bigbluebutton_branding_playback_copyright }}'';'
  ignore_errors: yes
  become: yes
  with_items:
    - /var/bigbluebutton/playback/presentation/0.9.0/playback.js
    - /var/bigbluebutton/playback/presentation/2.0/playback.js

- name: Create link to Mconf-Live.html
  file:
    src: /var/www/bigbluebutton/client/BigBlueButton.html
    dest: /var/www/bigbluebutton/client/Mconf-Live.html
    state: link
  become: yes
  when: not bigbluebutton_html5_only|bool

- name: Customize blinker
  replace:
    path: /var/www/bigbluebutton/client/lib/bbb_blinker.js
    regexp: '"BigBlueButton - " \+ title'
    replace: 'title'
  become: yes
  when: not bigbluebutton_html5_only|bool

- name: Update locale on the HTML5 client
  become: yes
  command: 'find /usr/share/meteor/bundle/programs/server/assets/app/locales/ -name "*.json" -exec sed -i "s|BigBlueButton|{{ bigbluebutton_branding_name }}|g" {} \;'
  when: bigbluebutton_html5
