- name: Read BigBlueButton source file
  slurp:
    src: /etc/apt/sources.list.d/bigbluebutton.list
  register: slurpfile
  ignore_errors: yes
  when: bigbluebutton_apt_clean_installation

- set_fact:
    current_apt_source: '{{ slurpfile["content"] | b64decode | regex_replace("\n") }}'
  when: bigbluebutton_apt_clean_installation and slurpfile is succeeded and not slurpfile is skipped

- include: clean-installation.yml
  when: bigbluebutton_apt_clean_installation and slurpfile is succeeded and current_apt_source != bigbluebutton_apt_source

- name: Update apt (if older than 60m)
  become: true
  apt: update_cache=yes cache_valid_time=3600

- name: Install language pack
  become: true
  apt:
    name: language-pack-en
    state: '{{ bigbluebutton_apt_state }}'
    autoremove: yes

- name: Install entropy daemon
  become: true
  apt:
    name: haveged
    state: '{{ bigbluebutton_apt_state }}'

- name: Enable haveged daemon
  service:
    name: haveged
    state: started
    enabled: yes
  become: yes

- name: Accept mscorefonts EULA
  become: true
  shell: echo ttf-mscorefonts-installer msttcorefonts/accepted-mscorefonts-eula select true | debconf-set-selections

- name: Generate locales
  become: true
  command: locale-gen en_US.UTF-8

- name: Reconfigure locales
  become: true
  command: dpkg-reconfigure --frontend=noninteractive locales

- name: Set default locale
  become: true
  command: update-locale LANG=en_US.UTF-8

- name: Add BigBlueButton apt key
  become: true
  apt_key:
    url: '{{ item }}'
    state: present
  register: aptkey
  with_items:
    - '{{ bigbluebutton_apt_key }}'
    - https://deb.nodesource.com/gpgkey/nodesource.gpg.key

- name: Find repos to remove
  become: true
  find:
    paths: /etc/apt/sources.list.d
    pattern: 'jenkins_live_mconf_com*'
  register: jenkins_repos

- name: Clear repos
  become: true
  file:
    path: '{{ item }}'
    state: absent
  with_items: "{{ jenkins_repos.files | map(attribute='path') | list + [ '/etc/apt/sources.list.d/archive_ubuntu_com_ubuntu.list', '/etc/apt/sources.list.d/deb_nodesource_com_node_8_x.list' ] | list }}"

- name: Add multiverse and BigBlueButton repos to apt
  become: true
  apt_repository:
    repo: '{{ item.repo }}'
    filename: '{{ item.filename }}'
    state: present
  register: aptrepos
  with_items:
    - { repo: 'deb http://archive.ubuntu.com/ubuntu/ {{ ansible_lsb.codename }} universe multiverse', filename: 'ubuntu' }
    - { repo: 'deb http://archive.ubuntu.com/ubuntu/ {{ ansible_lsb.codename }}-security universe multiverse', filename: 'ubuntu_security' }
    - { repo: 'deb http://archive.ubuntu.com/ubuntu/ {{ ansible_lsb.codename }}-updates universe multiverse', filename: 'ubuntu_updates' }
    - { repo: '{{ bigbluebutton_apt_source }}', filename: '{{ bigbluebutton_apt_package }}' }
    - { repo: 'deb http://deb.nodesource.com/node_8.x {{ ansible_lsb.codename }} main', filename: 'node' }
    - { repo: 'ppa:rmescandon/yq', filename: 'yq' }
    - { repo: 'ppa:nginx/stable', filename: 'nginx' }

- name: Update apt if keys changed
  become: true
  apt: update_cache=yes
  when: aptkey is changed or aptrepos is changed

- name: Remove kurento-media-server-6.0
  become: true
  apt:
    name: kurento-media-server-6.0
    state: absent
    autoremove: yes

- service:
    name: kurento-media-server-6.0
    state: stopped
  become: true
  ignore_errors: yes

- file:
    name: /etc/init.d/kurento-media-server-6.0
    state: absent
  become: true

- name: Install BigBlueButton
  become: true
  apt:
    name: '{{ bigbluebutton_apt_package }}'
    state: '{{ bigbluebutton_apt_state }}'
  notify: restart bigbluebutton

- name: Install bbb-webrtc-sfu
  become: true
  apt:
    name: bbb-webrtc-sfu
    state: '{{ bigbluebutton_apt_state }}'
  when: not bigbluebutton_docker_webrtc_sfu_enabled

- name: Auto-remove to avoid no space left on /boot
  become: true
  command: apt-get -y autoremove

- name: Upgrade packages to make sure BigBlueButton packages are updated
  become: true
  apt:
    upgrade: safe
  when: bigbluebutton_apt_state == 'latest'
  notify: restart bigbluebutton

- name: Check if bbb-web is running on a standalone app
  stat:
    path: /usr/share/bbb-web/WEB-INF/classes/bigbluebutton.properties
  register: reg_standalone
- set_fact:
    bigbluebutton_servlet_dir: /usr/share/bbb-web
  when: reg_standalone.stat.exists
- set_fact:
    bigbluebutton_servlet_dir: /var/lib/tomcat7/webapps/bigbluebutton
  when: not reg_standalone.stat.exists

- name: Determine if reset encoding needed on bigbluebutton.properties
  set_fact:
    properties_charset: 'iso-8859-1'

- name: Create certs directory for nginx
  file:
    path: /etc/nginx/ssl
    recurse: yes
    state: directory
  become: yes

- name: Generate dhparam
  command: openssl dhparam -out /etc/nginx/ssl/dhp-2048.pem 2048
  args:
    creates: /etc/nginx/ssl/dhp-2048.pem
  become: yes
  notify: reload nginx

- name: Copy certificates
  copy:
    src: '{{ item.src }}'
    dest: '{{ item.dest }}'
  become: yes
  with_items:
    - { src: '{{ bigbluebutton_local_ssl_certificate }}', dest: '{{ bigbluebutton_ssl_certificate }}' }
    - { src: '{{ bigbluebutton_local_ssl_certificate_key }}', dest: '{{ bigbluebutton_ssl_certificate_key }}' }
  when: not bigbluebutton_local_ssl_certificate is none and not bigbluebutton_local_ssl_certificate_key is none
  ignore_errors: yes
  notify: reload nginx

- name: Determine if use self signed certificate
  set_fact:
    use_self_signed_certificate: '{{ bigbluebutton_local_ssl_certificate is none and not certbot_enabled }}'

- include: self-signed-certs.yml
  when: use_self_signed_certificate

- name: Add ssl configuration on nginx
  blockinfile:
    dest: /etc/nginx/sites-available/bigbluebutton
    block: |2
           listen 443 ssl;
           listen [::]:443 ssl;
           ssl_certificate {{ bigbluebutton_ssl_certificate }};
           ssl_certificate_key {{ bigbluebutton_ssl_certificate_key }};
           ssl_session_cache shared:SSL:10m;
           ssl_session_timeout 10m;
           # need TLSv1 for the Java calls for the API, otherwise it would be removed
           ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
           ssl_ciphers "EECDH+AESGCM:EDH+AESGCM:AES256+EECDH:AES256+EDH";
           ssl_prefer_server_ciphers on;
           ssl_dhparam /etc/nginx/ssl/dhp-2048.pem;
           ssl_ecdh_curve secp384r1; # Requires nginx >= 1.1.0
           ssl_session_tickets off; # Requires nginx >= 1.5.9
           ssl_stapling on; # Requires nginx >= 1.3.7
           ssl_stapling_verify on; # Requires nginx => 1.3.7
           # still unclear why we need to set the resolver
           # resolver $DNS-IP-1 $DNS-IP-2 valid=300s;
           # resolver_timeout 5s;
           add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload";

           # define an upload limit for the whole site
           client_max_body_size 30m;
    insertafter: '.*server_name .*'
    marker: '     # {mark} ANSIBLE MANAGED BLOCK'
  become: yes
  notify: reload nginx

- name: Set server_name on nginx
  replace:
    path: /etc/nginx/sites-available/bigbluebutton
    regexp: '^([ \t]*server_name)[ \t]?.*'
    replace: '\1 {{ inventory_hostname }};'
  become: yes
  notify: reload nginx

- name: Install demos
  become: true
  apt:
    name: bbb-demo
    state: '{{ bigbluebutton_apt_state }}'
  when: bigbluebutton_demos
  register: reg_demo

- name: Restart tomcat7
  become: true
  service:
    name: tomcat7
    state: restarted
  when: reg_demo.changed

- name: Wait until demo is deployed before continuing
  wait_for:
    path: /var/lib/tomcat7/webapps/demo/bbb_api_conf.jsp
  when: bigbluebutton_demos

- name: Copy demo0
  become: true
  copy:
    src: files/demo0.jsp
    dest: /var/lib/tomcat7/webapps/demo/demo0.jsp
  when: bigbluebutton_demos

- name: Remove demos
  become: true
  apt:
    name: bbb-demo
    state: absent
  when: not bigbluebutton_demos

- name: Make sure demo is removed
  file:
    path: /var/lib/tomcat7/demo
    state: absent
  become: yes
  when: not bigbluebutton_demos

- name: Get BigBlueButton secret
  shell: cat {{ bigbluebutton_servlet_dir }}/WEB-INF/classes/bigbluebutton.properties | grep '^securitySalt=' | cut -d'=' -f2
  register: reg_bbb_secret

- name: Get BigBlueButton URL
  shell: cat {{ bigbluebutton_servlet_dir }}/WEB-INF/classes/bigbluebutton.properties | grep '^bigbluebutton.web.serverURL=' | cut -d'=' -f2 | awk '{print $1"/bigbluebutton/"}'
  register: reg_bbb_url

- name: Determine if setip is needed
  set_fact:
    setip_needed: '{{ not reg_bbb_url.stdout is search("http[s]?://" + inventory_hostname) }}'
    bbb_url: '{{ reg_bbb_url.stdout }}'
    bbb_secret: '{{ reg_bbb_secret.stdout }}'

- name: bbb-conf --setip
  become: true
  command: bbb-conf --setip '{{ inventory_hostname }}'
  when: setip_needed

- name: Get BigBlueButton secret again
  shell: cat {{ bigbluebutton_servlet_dir }}/WEB-INF/classes/bigbluebutton.properties | grep '^securitySalt=' | cut -d'=' -f2
  register: reg_bbb_secret
  when: setip_needed

- name: Get BigBlueButton URL again
  shell: cat {{ bigbluebutton_servlet_dir }}/WEB-INF/classes/bigbluebutton.properties | grep '^bigbluebutton.web.serverURL=' | cut -d'=' -f2 | awk '{print $1"/bigbluebutton/"}'
  register: reg_bbb_url
  when: setip_needed

- name: Determine URL and secret again
  set_fact:
    bbb_url: '{{ reg_bbb_url.stdout }}'
    bbb_secret: '{{ reg_bbb_secret.stdout }}'
  when: setip_needed

- name: Configure akka apps
  become: yes
  lineinfile:
    dest: /usr/share/bbb-apps-akka/conf/application.conf
    state: present
    regexp: '{{ item.regexp }}'
    line: '{{ item.line }}'
  with_items:
    - { regexp: 'bbbWebAPI[ ]*=', line: '  bbbWebAPI = "{{ bbb_url }}api"' }
    - { regexp: 'sharedSecret[ ]*=', line: '  sharedSecret = "{{ bbb_secret }}"' }
    - { regexp: 'deskshareip[ ]*=', line: '  deskshareip = "{{ inventory_hostname }}"' }
  notify: restart bigbluebutton

# TODO move this to a new role/task
- name: Install dependency for yedit library
  become: true
  pip:
    name: ruamel.yaml
    version: 0.15.37
    state: present

- name: Adjust bigbluebutton.yml
  become: yes
  yedit:
    src: /usr/local/bigbluebutton/core/scripts/bigbluebutton.yml
    edits:
    - { key: 'playback_host', value: '{{ bigbluebutton_playback_host | default(inventory_hostname, true) }}' }
    - { key: 'playback_protocol', value: '{{ bigbluebutton_playback_protocol | default("https", true) }}' }
    state: present

- name: Set HTTPS on bigbluebutton.properties
  replace:
    path: '{{ item[0] }}'
    regexp: '{{ item[1].regexp }}'
    replace: '{{ item[1].replace }}'
    encoding: '{{ properties_charset }}'
  with_nested:
    -
      - '{{ bigbluebutton_servlet_dir }}/WEB-INF/classes/bigbluebutton.properties'
      - /var/lib/tomcat7/webapps/demo/bbb_api_conf.jsp
      - /usr/share/red5/webapps/screenshare/WEB-INF/screenshare.properties
    -
      - { regexp: 'http[s]?:\/\/{{ inventory_hostname }}', replace: 'https://{{ inventory_hostname }}' }
      - { regexp: 'http[s]?:\/\/{{ ansible_default_ipv4.address }}', replace: 'https://{{ inventory_hostname }}' }
      - { regexp: 'rtmp:\/\/{{ ansible_default_ipv4.address }}', replace: 'rtmp://{{ inventory_hostname }}' }
  ignore_errors: yes
  become: yes
  notify: restart bigbluebutton

- name: Customize bigbluebutton.properties
  replace:
    path: '{{ bigbluebutton_servlet_dir }}/WEB-INF/classes/bigbluebutton.properties'
    regexp: '^({{ item.key }})=.*'
    replace: '\1={{ item.value }}'
    encoding: '{{ properties_charset }}'
  with_items: '{{ bigbluebutton_properties_config }}'
  when: not item.value is none
  become: yes
  notify: restart bigbluebutton

- name: Determine external IP
  set_fact:
    external_ip: "{{ lookup('pipe', 'dig {{ inventory_hostname }} @8.8.8.8 A +short | grep \"[0-9]*\\.[0-9]*\\.[0-9]*\\.[0-9]*\" | head -n 1') }}"
  when: external_ip is none
- name: Set external IP as internal IP if nothing returns from dig
  set_fact:
    external_ip: '{{ ansible_default_ipv4.address }}'
  when: external_ip is none or external_ip | trim == ""

# http://docs.bigbluebutton.org/install/install.html#configure-a-dummy-nic-if-required
- name: Check if external IP is accessible
  command: 'curl --max-time 5 --trace-ascii - -k https://{{ external_ip }}:443/favicon.ico'
  ignore_errors: yes
  register: reg_external_ip_access

- name: Restart nginx just to make sure
  become: yes
  service:
    name: nginx
    state: restarted
  when: reg_external_ip_access is failed

- name: Check if external IP is accessible again
  command: 'curl --max-time 5 --trace-ascii - -k https://{{ external_ip }}:443/favicon.ico'
  ignore_errors: yes
  register: reg_external_ip_access
  when: reg_external_ip_access is failed

- name: Check if external IP is assigned to any interface
  shell: ip addr | grep 'inet {{ external_ip }}'
  ignore_errors: yes
  register: reg_external_ip_assigned

- name: Add dummy NIC
  command: 'ip addr add {{ external_ip }}/32 dev lo'
  become: yes
  when: reg_external_ip_assigned is failed or reg_external_ip_access is failed

- name: Add dummy NIC to network interfaces
  blockinfile:
    dest: /etc/network/interfaces
    block: |2
              post-up ip addr add {{ external_ip }}/32 dev lo
              pre-down ip addr del {{ external_ip }}/32 dev lo
    insertafter: 'iface lo inet loopback'
    marker: '        # {mark} ANSIBLE MANAGED BLOCK'
  become: yes
  when: reg_external_ip_assigned is failed or reg_external_ip_access is failed

- name: Confirm if external IP is accessible
  command: 'curl --max-time 5 --trace-ascii - -k https://{{ external_ip }}:443/favicon.ico'

- name: Set HTTPS on sip.nginx
  replace:
    path: '/etc/bigbluebutton/nginx/sip.nginx'
    regexp: 'http[s]?:\/\/[0-9\.]*:\d+'
    replace: 'https://{{ external_ip }}:7443'
  become: yes
  notify: reload nginx

- name: Update bbb-webrtc-sfu config
  yedit:
    src: /usr/local/bigbluebutton/bbb-webrtc-sfu/config/default.yml
    edits:
    - { key: 'minVideoPort', value: '{{ bigbluebutton_html5_udp_range_begin }}' }
    - { key: 'maxVideoPort', value: '{{ bigbluebutton_html5_udp_range_end }}' }
    - { key: 'kurentoIp', value: '{{ external_ip }}' }
    - { key: 'localIpAddress', value: '{{ external_ip }}' }
    - { key: 'acceptSelfSignedCertificate', value: '{{ use_self_signed_certificate }}' }
    - { key: 'mediaFlowTimeoutDuration', value: '15000' }
    - { key: 'websocketPongTimeout', value: '15000' }
    - { key: 'common-message-version', value: '{% if bigbluebutton_html5 %}2.x{% else %}1.x{% endif %}' }
    - { key: 'freeswitch.ip', value: '{{ ansible_default_ipv4.address }}' }
    - { key: 'kurentoUrl', value: 'ws://{{ ansible_default_ipv4.address }}:8888/kurento' }
    - { key: 'recordScreenSharing', value: '{% if bigbluebutton_html5 %}true{% else %}false{% endif %}' }
    - { key: 'recordWebcams', value: '{% if bigbluebutton_html5 %}true{% else %}false{% endif %}' }
    - { key: 'kurento-websocket-pool-size', value: '1' }
    - { key: 'maxAudioConnections', value: '300' }
    state: present
  become: yes
  when: not bigbluebutton_docker_webrtc_sfu_enabled
  notify: restart bbb-webrtc-sfu

- name: Open/close redis
  become: true
  lineinfile:
    dest: /etc/redis/redis.conf
    state: present
    regexp: '^bind\s'
    line: 'bind {{ bigbluebutton_redis_bind | join(" ") }}'
  when: bigbluebutton_redis_bind
  notify: restart redis

- name: Close redis to localhost
  become: true
  lineinfile:
    dest: /etc/redis/redis.conf
    state: present
    regexp: '^bind\s'
    line: 'bind 127.0.0.1'
  when: not bigbluebutton_redis_bind
  notify: restart redis

- name: Copy presentation
  copy:
    src: '{{ bigbluebutton_default_presentation }}'
    dest: /var/www/bigbluebutton-default/default.pdf
  when: not bigbluebutton_default_presentation is none
  become: yes

- name: Configure retention
  become: true
  lineinfile:
    dest: /etc/cron.daily/bigbluebutton
    state: present
    regexp: '{{ item.regexp }}'
    line: '{{ item.line }}'
  with_items:
  - { regexp: '^history=', line: 'history={{ bigbluebutton_retention_runtime }}' }
  - { regexp: '^unrecorded_days=', line: 'unrecorded_days={{ bigbluebutton_retention_unrecorded }}' }
  - { regexp: '^published_days=', line: 'published_days={{ bigbluebutton_retention_published_raw }}' }
  - { regexp: '^log_history=', line: 'log_history={{ bigbluebutton_log_retention }}' }
  - { regexp: '^[#]?remove_raw_of_recordings_without_marks$', line: 'remove_raw_of_recordings_without_marks', when: '{{ not bigbluebutton_retention_unrecorded is none }}' }
  - { regexp: '^[#]?remove_raw_of_recordings_without_marks$', line: '#remove_raw_of_recordings_without_marks', when: '{{ bigbluebutton_retention_unrecorded is none }}' }
  - { regexp: '^[#]?remove_raw_of_published_recordings$', line: 'remove_raw_of_published_recordings', when: '{{ not bigbluebutton_retention_published_raw is none }}' }
  - { regexp: '^[#]?remove_raw_of_published_recordings$', line: '#remove_raw_of_published_recordings', when: '{{ bigbluebutton_retention_published_raw is none }}' }
  when: item.when is undefined or item.when == true

- include: stun.yml

- include: freeswitch.yml

- include: config-xml.yml
  when: not bigbluebutton_html5_only

- include: webhooks.yml

- include: html5.yml
  when: bigbluebutton_html5

- include: sip.yml
  when: bigbluebutton_sip and not bigbluebutton_docker_mcs_sip_enabled

- include: branding.yml
  tags:
    - branding

- include: ufw.yml
  when: common_ufw_enabled
  tags: [ufw,firewall]

- include: zabbix.yml
  when: bigbluebutton_zabbix_copy_scripts or zabbix_agent_enabled
  tags: [zabbix]

# - include: rap-resque.yml
#   tags: [rap]

- name: Copy scripts for recordings
  synchronize:
    src: files/utils/
    dest: /usr/local/bigbluebutton/core/scripts/utils/
  become: yes

- name: Install cron job to remove media files from non-recorded meetings
  cron:
    name: remove norecord
    special_time: hourly
    job: /usr/bin/ruby /usr/local/bigbluebutton/core/scripts/utils/remove-norecord.rb
    user: root
    state: '{% if bigbluebutton_retention_unrecorded == 0 %}present{% else %}absent{% endif %}'
  become: yes

- name: Install cron job to remove media files already archived
  cron:
    name: remove archived
    special_time: hourly
    job: /usr/bin/ruby /usr/local/bigbluebutton/core/scripts/utils/clean-recordings-data.rb
    user: root
  become: yes

- name: Install cron job to remove encrypted files after 7 days
  cron:
    name: remove encrypted
    special_time: daily
    job: /usr/local/bigbluebutton/core/scripts/utils/remove-encrypted.sh
    user: root
  become: yes

- set_fact:
    restart_mconf_command: /usr/bin/ruby /usr/local/bigbluebutton/core/scripts/utils/end-all.rb >> /var/log/restart-mconf.log 2>&1; sleep 30; /usr/local/bigbluebutton/core/scripts/utils/restart-mconf.sh >> /var/log/restart-mconf.log 2>&1
- set_fact:
    restart_mconf_command: '{{ restart_mconf_command }}; systemctl stop bbb-webrtc-sfu kurento; systemctl disable bbb-webrtc-sfu kurento; docker restart $(docker ps -f "name=kurento_*" -q); docker restart webrtc-sfu mcs-sip sfu-phone'
  when: bigbluebutton_docker_webrtc_sfu_enabled
- set_fact:
    restart_mconf_command: '{{ restart_mconf_command }}; systemctl stop red5 bbb-transcode-akka; systemctl disable red5 bbb-transcode-akka'
  when: bigbluebutton_html5_only

- name: Install cron job to restart KMS daily
  cron:
    name: restart kms
    minute: 0
    hour: 4
    user: root
    state: absent
  become: yes

- name: Install cron job to restart Mconf daily
  cron:
    name: restart mconf
    minute: 0
    hour: 4
    job: '{{ restart_mconf_command }}'
    user: root
  become: yes

- name: Install cron job to generate audio-stats
  cron:
    name: enable audio-stats, sleep {{ item }})
    job: sleep {{ item }}; /usr/bin/ruby /usr/local/bigbluebutton/core/scripts/utils/audio-stats.rb
    user: root
  become: yes
  with_items:
    - 30
    - 60

- include: tune-so.yml

- include: storage-partition.yml
  when: bigbluebutton_storage_dir is not none
  tags: [storage]

- include: log.yml

# - name: Check if reboot is required
#   stat:
#     path: /var/run/reboot-required
#   register: reg_reboot
#
# - name: Notify when reboot is required
#   command: 'true'
#   notify: reboot
#   when: reg_reboot.stat.exists
