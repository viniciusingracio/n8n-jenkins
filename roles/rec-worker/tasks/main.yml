- name: Download rec-worker source code
  git:
    repo: '{{ rec_worker_repo_url }}'
    dest: ~/src/rec-worker
    version: '{{ rec_worker_repo_ref }}'
    depth: 1 # just a snapshot
    accept_hostkey: true
  when: rec_worker_build_from_source

- name: Build the rec-worker docker image
  docker_image:
    build_path: ~/src/rec-worker/record-and-playback/
    name: mconf/bbb-rap
    # force: true
  when: rec_worker_build_from_source

- name: Start the rec-worker container
  docker_container:
    name: rec-worker
    image: mconf/bbb-rap:latest
    restart_policy: unless-stopped
    # command: ["sleep", "infinity"]
    volumes:
      - /var/bigbluebutton:/var/bigbluebutton
      - /var/log/bigbluebutton:/var/log/bigbluebutton
      # - /home/ubuntu/.ssh:/root/.ssh
    env:
      REDIS_HOST: '{{ rec_worker_redis_host }}'
      REDIS_PORT: '{{ rec_worker_redis_port }}'
      REDIS_WORKERS_HOST: '{{ rec_worker_redis_host }}'
      REDIS_WORKERS_PORT: '{{ rec_worker_redis_port }}'
      HOST_ADDRESS: '{{ ansible_default_ipv4.address }}'
      HOST_USER: '{{ deploy_user }}'
      QUEUE: '{{ rec_worker_queues }}'
