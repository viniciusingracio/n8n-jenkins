- name: Install bindfs
  become: yes
  apt:
    name: 'bindfs'
    state: present

- file:
    path: '{{ item }}'
    mode: 0755
    recurse: yes
    state: directory
  become: yes
  with_items:
    - /opt/kurento-recordings/video
    - /mnt/kurento-recordings

- name: Add bindfs to fstab
  blockinfile:
    dest: /etc/fstab
    block: |
      bindfs#/opt/kurento-recordings /mnt/kurento-recordings fuse force-user={{ ansible_user }} 0 0
    marker: '# {mark} ANSIBLE MANAGED BLOCK - vtraining-rec'
    create: yes
  become: yes

- name: Test mount
  command: mountpoint -q -- /mnt/kurento-recordings
  register: recordings_mount
  ignore_errors: yes

- name: Mount bindfs
  command: mount -a
  become: yes
  when: recordings_mount is failed

- file:
    src: /mnt/kurento-recordings/video
    dest: '{{ ansible_env.HOME }}/dev/vtraining/public/video'
    state: link
