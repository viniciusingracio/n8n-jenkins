---

- name: Remove webhooks package
  become: yes
  apt:
    name: bbb-webhooks
    state: absent

- name: Check if bbb-web is running on a standalone app
  stat:
    path: /usr/share/bbb-web/WEB-INF/classes/bigbluebutton.properties
  register: reg_standalone
- set_fact:
    bigbluebutton_servlet_dir: /usr/share/bbb-web
    bigbluebutton_user: bigbluebutton
    bbb_web_port: 8090
  when: reg_standalone.stat.exists
- set_fact:
    bigbluebutton_servlet_dir: /var/lib/tomcat7/webapps/bigbluebutton
    bigbluebutton_user: tomcat7
    bbb_web_port: 8080
  when: not reg_standalone.stat.exists

- name: Get BigBlueButton secret
  shell: cat {{ bigbluebutton_servlet_dir }}/WEB-INF/classes/bigbluebutton.properties | grep '^securitySalt=' | cut -d'=' -f2
  register: bbb_secret_raw

- name: Get BigBlueButton URL
  shell: cat {{ bigbluebutton_servlet_dir }}/WEB-INF/classes/bigbluebutton.properties | grep '^bigbluebutton.web.serverURL=' | cut -d'=' -f2 | awk '{print $1"/bigbluebutton/api"}'
  register: bbb_api_entry_point_raw

- set_fact:
    bbb_secret: '{{ bbb_secret_raw.stdout }}'
    bbb_api_entry_point: '{{ bbb_api_entry_point_raw.stdout }}'

- name: Register Docker host IP
  shell: "ifconfig docker0 | grep 'inet addr:' | cut -d: -f2 | awk '{print $1}'"
  register: docker_ip_raw

- set_fact:
    docker_ip: '{{ docker_ip_raw.stdout }}'

- name: Start bbb-webhooks container
  docker_container:
    name: webhooks
    image: '{{ bigbluebutton_docker_webhooks_image }}'
    pull: yes
    restart_policy: always
    ports:
      - "3005:3005"
    env:
      REDIS_HOST: '{{ docker_ip }}'
      SHARED_SECRET: '{{ bbb_secret }}'
      BEARER_AUTH: '1'
      SERVER_DOMAIN: '{{ inventory_hostname }}'
      PERMANENT_HOOKS: '{{ bigbluebutton_docker_webhooks_permanent_hooks | to_json }}'
    labels:
      hostname: '{{ inventory_hostname }}'
    state: '{% if bigbluebutton_webhooks %}started{% else %}absent{% endif %}'

- name: Add webhooks to nginx
  become: yes
  copy:
    src: files/webhooks.nginx
    dest: /etc/bigbluebutton/nginx/webhooks.nginx
  when: bigbluebutton_webhooks
  notify: reload nginx

- name: Remove webhooks from nginx
  become: yes
  file:
    path: /etc/bigbluebutton/nginx/webhooks.nginx
    state: absent
  when: not bigbluebutton_webhooks
  notify: reload nginx
