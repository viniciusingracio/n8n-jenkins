# TODO: setup cron

# TODO: make a module with this?
- name: Check if port 80 is used
  become: true
  shell: netstat -tuln | grep :80
  register: port_80
  failed_when: False # never fail


#
# If nothing binding to port 80, use certbot standalone
#

- name: Open firewall for certbot standalone
  become: true
  ufw: rule=allow port=80 proto=tcp
  notify: restart ufw
  register: certbot_standalone_fw
  when: port_80.rc == 1

- name: Start the certbot container standalone
  docker_container:
    name: certbot
    image: certbot/certbot
    command: '{{ certbot_standalone_cmd }}'
    volumes:
      - /etc/letsencrypt:/etc/letsencrypt
    published_ports:
      - 80:80
    # auto_remove: true # on ansible 2.4
    detach: false
  when: port_80.rc == 1
  register: certb

- name: Close firewall after certbot standalone
  become: true
  ufw: rule=allow port=80 proto=tcp delete=true
  notify: restart ufw
  when: port_80.rc == 1 and certbot_standalone_fw.changed


#
# If something already using port 80, try webroot
#

- name: Start the certbot container webroot
  docker_container:
    name: certbot
    image: certbot/certbot
    command: '{{ certbot_webroot_cmd }}'
    volumes:
      - /var/www:/var/www # webroot
      - /etc/letsencrypt:/etc/letsencrypt
    # auto_remove: true # on ansible 2.4
    detach: false
  when: port_80.rc == 0
