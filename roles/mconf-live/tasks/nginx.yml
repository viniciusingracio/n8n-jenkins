- stat:
    path: '{{ item }}'
  with_items:
    - /etc/bigbluebutton/nginx/presentation.nginx
    - /etc/bigbluebutton/nginx/presentation_video.nginx
  register: nginx_files

- command: mv {{ item.item }}.orig {{ item.item }}
  with_items: '{{ nginx_files.results }}'
  become: yes
  when: item.stat.exists and item.stat.islnk and not mconf_live_rec_proxy_enabled
  notify: reload nginx

- command: mv {{ item.item }} {{ item.item }}.orig
  with_items: '{{ nginx_files.results }}'
  become: yes
  when: item.stat.exists and not item.stat.islnk and mconf_live_rec_proxy_enabled
  notify: reload nginx

- template:
    src: templates/{{ item.item | basename }}.j2
    dest: '{{ item.item }}.openresty'
  with_items: '{{ nginx_files.results }}'
  become: yes
  when: item.stat.exists and mconf_live_rec_proxy_enabled
  notify: reload nginx

- file:
    path: '{{ item.item }}.openresty'
    state: absent
  with_items: '{{ nginx_files.results }}'
  become: yes
  when: not mconf_live_rec_proxy_enabled
  notify: reload nginx

- file:
    src: '{{ item.item }}.openresty'
    dest: '{{ item.item }}'
    state: link
  with_items: '{{ nginx_files.results }}'
  become: yes
  when: item.stat.exists and mconf_live_rec_proxy_enabled
  notify: reload nginx

- file:
    src: '{{ item.item }}.openresty'
    dest: '{{ item.item }}'
    state: link
  with_items: '{{ nginx_files.results }}'
  become: yes
  when: item.stat.exists and mconf_live_rec_proxy_enabled
  notify: reload nginx

- template:
    src: templates/rec_auth_token.nginx.j2
    dest: '/etc/bigbluebutton/nginx/rec_auth_token.nginx'
  become: yes
  when: mconf_live_rec_proxy_enabled
  notify: reload nginx

- file:
    path: '/etc/bigbluebutton/nginx/rec_auth_token.nginx'
    state: absent
  become: yes
  when: not mconf_live_rec_proxy_enabled
  notify: reload nginx

- name: Add recording server fallback
  blockinfile:
    dest: '{{ item.dest }}'
    block: |2
                      if (!-f {{ item.check }}) {
                              return 302 {{ mconf_live_rec_fallback }}$request_uri;
                      }

    insertafter: '{{ item.after }}'
    marker: '                # {mark} ANSIBLE MANAGED BLOCK server fallback'
  with_items:
    - { dest: "/etc/bigbluebutton/nginx/presentation.nginx", check: "/var/bigbluebutton/published/presentation/$arg_meetingId/shapes.svg", after: ".*location \\/playback\\/presentation {$" }
    - { dest: "/etc/bigbluebutton/nginx/presentation_video.nginx", check: "/var/bigbluebutton/published$uri", after: ".*location.* \\/presentation_video.*{$" }
  become: yes
  when: not mconf_live_rec_fallback is none
  ignore_errors: yes
  notify: reload nginx
