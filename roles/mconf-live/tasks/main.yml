- include_role:
    name: bigbluebutton
  tags: [bigbluebutton]

- name: Install extra recording formats
  become: true
  apt:
    name: '{{ item }}'
    state: 'latest'
  with_items: '{{ mconf_live_extra_recording_packages }}'

- include: rec-proxy.yml

- name: Copy sound
  copy:
    src: files/{{ mconf_live_sounds_hold_music }}
    dest: /opt/freeswitch/share/freeswitch/sounds/{{ mconf_live_sounds_hold_music }}
    owner: freeswitch
    group: daemon
  when: not mconf_live_sounds_hold_music is none
  become: true

- name: Create wav file
  command: ffmpeg -y -i /opt/freeswitch/share/freeswitch/sounds/{{ mconf_live_sounds_hold_music }} /opt/freeswitch/share/freeswitch/sounds/{{ (mconf_live_sounds_hold_music | splitext)[0] }}.wav
  args:
    creates: /opt/freeswitch/share/freeswitch/sounds/{{ (mconf_live_sounds_hold_music | splitext)[0] }}.wav
  when: not mconf_live_sounds_hold_music is none
  become: true

- name: Check if presentation_recorder is installed
  stat:
    path: /usr/local/bigbluebutton/core/scripts/mconf-presentation-recorder.yml
  register: reg_recorder

- name: Adjust mconf-presentation-recorder.yml
  replace:
    path: /usr/local/bigbluebutton/core/scripts/mconf-presentation-recorder.yml
    regexp: '{{ item.regexp }}'
    replace: '{{ item.replace }}'
  with_items:
    - { regexp: '^(api_entry_point): .*', replace: '\1: {{ bbb_api_entry_point.stdout }}' }
    - { regexp: '^(api_shared_secret): .*', replace: '\1: {{ bbb_secret.stdout }}' }
    - { regexp: '^(local_address): .*', replace: '\1: {{ ansible_default_ipv4 }}' }
    - { regexp: '^(simultaneous_meetings): .*', replace: '\1: {{ mconf_live_num_presentation_recorders }}' }
  become: yes
  when: reg_recorder.stat.exists
