- name: Start etherpad container
  docker_container:
    name: etherpad
    image: mconf/etherpad-lite:mconf
    pull: yes
    restart_policy: unless-stopped
    ports:
      - "3006:9001"
    env:
      SETTINGS_MODIFIER: '.dbSettings.host = "{{ docker_ip }}"'

- name: Add notes to nginx
  become: yes
  template:
    src: templates/notes.nginx.j2
    dest: /etc/bigbluebutton/nginx/notes.nginx
  notify: reload nginx

- name: Determine if json or yml config
  stat:
    path: /usr/share/meteor/bundle/programs/server/assets/app/config/settings-production.json
  register: reg_settings_json

- name: Update json values
  become: true
  json:
    path: /usr/share/meteor/bundle/programs/server/assets/app/config/settings-production.json
    replace:
      json_path: '{{ item.path }}'
      with_value: '{{ item.value }}'
    indent: 4
    insert_if_missing: true
  with_items:
    - { path: '/public/note/url', value: 'https://{{ inventory_hostname }}/pad' }
  notify: restart bbb-html5
  when: reg_settings_json.stat.exists

- name: Update yml values
  become: yes
  command: yq w -i /usr/share/meteor/bundle/programs/server/assets/app/config/settings.yml {{ item.key }} "{{ item.value }}"
  with_items:
    - { key: 'public.note.enabled', value: 'true' }
    - { key: 'public.note.url', value: 'https://{{ inventory_hostname }}/pad' }
    - { key: 'public.genericContent.multipleNotes.enabled', value: '{{ bigbluebutton_notes_multiple_enabled }}' }
  when: not reg_settings_json.stat.exists
