- name: Stop kurento
  become: true
  service: name=kurento-media-server state=stopped enabled=false

- name: Get number of cores
  shell: "grep -c ^processor /proc/cpuinfo"
  register: num_proc_auto_raw

- name: Determine number of kurento instances, in case it isn't set
  set_fact:
    num_proc_auto: '{{ [ num_proc_auto_raw.stdout|int, 2 ] | min }}'

- name: Determine number of kurento instances
  set_fact:
    num_proc: '{{ bigbluebutton_docker_kurento_instances | default(num_proc_auto, true) }}'

- name: Determine kurento ports
  set_fact:
    kurento_ports: '{{ kurento_ports|default([]) + [ (3100 + item|int)|string ] }}'
  with_sequence: start=0 count={{ num_proc }}

- name: Determine kurento running instances
  shell: docker ps | grep 'kurento_[0-9]*' | sed 's:.*kurento_\([0-9]*\)$:\1:g' | sort
  register: running_kurento_raw

- name: Stop kurento instances that we don't need
  docker_container:
    name: kurento_{{ item }}
    state: stopped
  with_items: '{{ running_kurento_raw.stdout_lines | difference(kurento_ports) }}'

- set_fact:
    kurento_ip: "{% if bigbluebutton_kurento_use_internal_ip %}{{ ansible_default_ipv4.address }}{% else %}{{ external_ip }}{% endif %}"

- name: Determine kurento URLs to configure bbb-webrtc-sfu
  set_fact:
    kurento_config: "{{ kurento_config|default([]) + [ { 'ip': kurento_ip, 'url': 'ws://' + docker_ip + ':' + item + '/kurento' } ] }}"
  with_items: '{{ kurento_ports }}'

- name: Start kurento containers
  docker_container:
    name: kurento_{{ item }}
    image: '{{ bigbluebutton_docker_kurento_image }}'
    pull: yes
    restart_policy: unless-stopped
    network_mode: host
    volumes:
      - /var/kurento:/var/kurento
      - /var/log/kurento-media-server:/var/log/kurento-media-server
    env:
      PORT: '{{ item }}'
      RTP_MIN_PORT: '{{ bigbluebutton_kms_udp_range_begin }}'
      RTP_MAX_PORT: '{{ bigbluebutton_kms_udp_range_end - 40 }}'
      KURENTO_LOGS_PATH: /var/log/kurento-media-server
      STUN_IP: '{{ stun_server_ip }}'
      STUN_PORT: '{{ stun_server_port }}'
  with_items: '{{ kurento_ports }}'
  notify: restart docker components

- name: Remove old images
  shell: docker images {{ bigbluebutton_docker_kurento_image.split(":")[0] }} --filter 'before={{ bigbluebutton_docker_kurento_image }}' -q | xargs -r docker rmi
  notify: clean docker

- name: Copy dummy package for bbb-webrtc-sfu to /tmp
  copy:
    src: files/bbb-webrtc-sfu_1.0_all.deb
    dest: /tmp/bbb-webrtc-sfu_1.0_all.deb

- name: Install dummy package
  apt:
    deb: /tmp/bbb-webrtc-sfu_1.0_all.deb
    force: yes
  become: yes

- name: Hold package
  command: apt-mark hold bbb-webrtc-sfu
  become: yes

- name: Hold package (with aptitude)
  command: aptitude -y hold bbb-webrtc-sfu
  become: yes

- name: Hold package (with dpkg)
  dpkg_selections:
    name: bbb-webrtc-sfu
    selection: hold
  become: yes

- name: Install node (webrtc-sfu dependency, set to automatic)
  apt:
    name: nodejs
    state: latest
  become: yes

- name: Pull streaming image
  docker_image:
    name: mconf/mconf-presentation-recorder:latest

- name:
  become: yes
  copy:
    content: '{{ bigbluebutton_streaming_secret }}'
    dest: /usr/local/bigbluebutton/bbb-webrtc-sfu/config/client_secret.json

- name:
  set_fact:
    sfu_processes: "{{ sfu_processes|default([]) + [ { 'path': item } ] }}"
  with_items:
    - ./lib/mcs-core/process.js
    - ./lib/screenshare/ScreenshareProcess
    - ./lib/video/VideoProcess.js
    - ./lib/audio/AudioProcess.js
- name:
  set_fact:
    sfu_processes: "{{ sfu_processes|default([]) + [ { 'path': item } ] }}"
  with_items:
    - ./lib/stream/StreamProcess.js
  when: bigbluebutton_streaming_enabled

- name: Start webrtc-sfu container
  docker_container:
    name: webrtc-sfu
    image: '{{ bigbluebutton_docker_webrtc_sfu_image }}'
    pull: yes
    restart_policy: unless-stopped
    ports:
      - 3008:3008
      - 3009:3009
      - 3010:8009
    env:
      KURENTO: '{{ kurento_config | to_json }}'
      REDIS_HOST: '{{ docker_ip }}'
      MCS_PORT: 3009
      MCS_HOST: '{{ docker_ip }}'
      FREESWITCH_IP: '{{ ansible_default_ipv4.address }}'
      ESL_IP: '{{ docker_ip }}'
      ESL_PORT: 8021
      LOG_LEVEL: info
      STREAM_CONTAINER_TYPE: docker
      STREAM_IMAGE_NAME: mconf/mconf-presentation-recorder:latest
      STREAM_BIGBLUEBUTTON_URL: '{{ bbb_api_entry_point | regex_replace("/api") }}'
      STREAM_BIGBLUEBUTTON_SECRET: '{{ bbb_secret }}'
      SFU_PROCESSES: '{{ sfu_processes | to_json }}'
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /usr/local/bigbluebutton/bbb-webrtc-sfu/config/client_secret.json:/app/client_secret.json
  notify: restart docker components

- name: Remove old images
  shell: docker images {{ bigbluebutton_docker_webrtc_sfu_image.split(":")[0] }} --filter 'before={{ bigbluebutton_docker_webrtc_sfu_image }}' -q | xargs -r docker rmi
  notify: clean docker

- name: Add webrtc-sfu to nginx
  become: yes
  template:
    src: templates/webrtc-sfu.nginx.j2
    dest: /etc/bigbluebutton/nginx/webrtc-sfu.nginx
  notify: reload nginx

