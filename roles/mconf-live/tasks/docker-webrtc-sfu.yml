- name: Copy dummy package for bbb-webrtc-sfu to /tmp
  copy:
    src: files/bbb-webrtc-sfu_1.0_all.deb
    dest: /tmp/bbb-webrtc-sfu_1.0_all.deb

- name: Install dummy package
  apt:
    deb: /tmp/bbb-webrtc-sfu_1.0_all.deb
    force: yes
  become: yes

- name: Hold package
  command: apt-mark hold bbb-webrtc-sfu
  become: yes

- name: Hold package (with aptitude)
  command: aptitude -y hold bbb-webrtc-sfu
  become: yes

- name: Hold package (with dpkg)
  dpkg_selections:
    name: bbb-webrtc-sfu
    selection: hold
  become: yes

- name: Install node (webrtc-sfu dependency, set to automatic)
  apt:
    name: nodejs
    state: latest
  become: yes

- name: Pull streaming image
  docker_image:
    name: '{{ mconf_live_presentation_recorder_image }}:{{ mconf_live_presentation_recorder_version }}'
    source: pull
    force_source: yes

# - name: Remove old images
#   shell: docker images {{ mconf_live_presentation_recorder_image }} --filter 'before={{ mconf_live_presentation_recorder_image }}:{{ mconf_live_presentation_recorder_version }}' -q | xargs -r docker rmi --force
#   notify: clean docker

- name:
  become: yes
  copy:
    content: '{{ bigbluebutton_streaming_secret }}'
    dest: /usr/local/bigbluebutton/bbb-webrtc-sfu/config/client_secret.json

- name:
  become: yes
  copy:
    src: '{{ bigbluebutton_docker_webrtc_sfu_k8s_local_config_file }}'
    dest: '{{ bigbluebutton_docker_webrtc_sfu_k8s_config_file }}'

- name:
  set_fact:
    sfu_processes: "{{ sfu_processes|default([]) + [ { 'path': item } ] }}"
  with_items:
    - ./lib/mcs-core/process.js
    - ./lib/screenshare/ScreenshareProcess
    - ./lib/video/VideoProcess.js
    - ./lib/audio/AudioProcess.js
- name:
  set_fact:
    sfu_processes: "{{ sfu_processes|default([]) + [ { 'path': item } ] }}"
  with_items:
    - ./lib/stream/StreamProcess.js
  when: bigbluebutton_streaming_enabled

- name:
  set_fact:
    bigbluebutton_docker_kurento_allowed_candidates: "{{ [ external_ip, ansible_default_ipv4.address ] | unique }}"
  when: bigbluebutton_docker_kurento_allowed_candidates is none

- name: Start webrtc-sfu container
  docker_container:
    name: webrtc-sfu
    image: '{{ bigbluebutton_docker_webrtc_sfu_image }}'
    pull: yes
    restart_policy: always
    memory: 768M
    ports:
      - 3008:3008
      - 3009:3009
      - 3010:8009
    env:
      KURENTO: '{{ kurento_config | to_json }}'
      REDIS_HOST: '{{ docker_ip }}'
      MCS_PORT: "3009"
      MCS_HOST: 0.0.0.0
      CLIENT_HOST: 0.0.0.0
      MCS_ADDRESS: '{{ docker_ip }}'
      # this can be removed when everyone is using v2.4 or above
      FREESWITCH_IP: '{{ ansible_default_ipv4.address }}'
      FREESWITCH_SIP_IP: '{{ ansible_default_ipv4.address }}'
      FREESWITCH_CONN_IP: '{{ kurento_ip }}'
      ESL_IP: '{{ docker_ip }}'
      ESL_PORT: "8021"
      LOG_LEVEL: info
      STREAM_CONTAINER_TYPE: '{% if bigbluebutton_docker_webrtc_sfu_k8s_enabled %}kubernetes{% else %}docker{% endif %}'
      STREAM_IMAGE_NAME: '{{ mconf_live_presentation_recorder_image }}:{{ mconf_live_presentation_recorder_version }}'
      STREAM_BIGBLUEBUTTON_URL: '{{ bbb_api_entry_point | regex_replace("/api") }}'
      STREAM_BIGBLUEBUTTON_SECRET: '{{ bbb_secret }}'
      STREAM_BOT_NAME: 'Streaming'
      STREAM_K8S_NAMESPACE: streaming
      SFU_PROCESSES: '{{ sfu_processes | to_json }}'
      CODEC_VIDEO_MAIN: '{{ bigbluebutton_docker_webrtc_sfu_codec }}'
      CODEC_VIDEO_CONTENT: '{{ bigbluebutton_docker_webrtc_sfu_codec }}'
      VIDEO_SUBSCRIBER_SLAVE: 'true'
      SCREENSHARE_SUBSCRIBER_SLAVE: 'true'
      VIDEO_RNP_BASE_URL: '{{ bigbluebutton_video_rnp_endpoint_hostname }}'
      VIDEO_RNP_CLIENT_ID: '{{ bigbluebutton_video_rnp_client_id | string }}'
      VIDEO_RNP_CLIENT_SECRET: '{{ bigbluebutton_video_rnp_client_secret | string }}'
      VIDEO_RNP_REDIRECT_URI: 'https://{{ inventory_hostname }}/oauth2_redirect'
      VIDEO_RNP_HOST_IP: '{{ external_ip }}'
      KURENTO_ALLOWED_CANDIDATE_IPS: '{{ bigbluebutton_docker_kurento_allowed_candidates | default("", true) | to_json }}'
      LOG_FILENAME: /var/log/bbb-webrtc-sfu/bbb-webrtc-sfu.log
      TZ: '{{ lookup("file", "/etc/timezone") }}'
      FREESWITCH_IP_MAPPINGS: '{{ ip_mappings | to_json }}'
      KUBECONFIG: '{% if bigbluebutton_docker_webrtc_sfu_k8s_enabled %}/app/kube-config{% endif %}'
    volumes:
      - /var/log/bbb-webrtc-sfu:/var/log/bbb-webrtc-sfu
      - /var/run/docker.sock:/var/run/docker.sock
      - /usr/local/bigbluebutton/bbb-webrtc-sfu/config/client_secret.json:/app/client_secret.json
      - '{{ bigbluebutton_docker_webrtc_sfu_k8s_config_file }}:/app/kube-config'
    labels:
      hostname: '{{ inventory_hostname }}'
  notify: restart docker components

- name: Remove old images
  shell: docker images {{ bigbluebutton_docker_webrtc_sfu_image.split(":")[0] }} --filter 'before={{ bigbluebutton_docker_webrtc_sfu_image }}' -q | xargs -r docker rmi --force
  notify: clean docker

- name: Add webrtc-sfu to nginx
  become: yes
  template:
    src: templates/webrtc-sfu.nginx.j2
    dest: /etc/bigbluebutton/nginx/webrtc-sfu.nginx
  notify: reload nginx
