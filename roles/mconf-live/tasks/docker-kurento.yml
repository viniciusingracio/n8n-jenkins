- name: Stop kurento
  become: true
  service: name=kurento-media-server state=stopped enabled=false

- name: Get number of cores
  shell: "grep -c ^processor /proc/cpuinfo"
  register: num_proc_auto_raw

- name: Determine number of kurento instances, in case it isn't set
  set_fact:
    num_proc_auto: '{{ [ num_proc_auto_raw.stdout|int, 2 ] | min }}'

- name: Determine number of kurento instances
  set_fact:
    num_proc: '{{ bigbluebutton_docker_kurento_instances | default(num_proc_auto, true) }}'

- name: Determine kurento ports
  set_fact:
    kurento_ports: '{{ kurento_ports|default([]) + [ (bigbluebutton_docker_kurento_first_port|int + item|int)|string ] }}'
  with_sequence: start=0 count={{ num_proc }}

- name: Determine kurento running instances
  shell: docker ps | grep 'kurento_[0-9]*' | sed 's:.*kurento_\([0-9]*\)$:\1:g' | sort
  register: running_kurento_raw

- name: Stop kurento instances that we don't need
  docker_container:
    name: kurento_{{ item }}
    state: stopped
  with_items: '{{ running_kurento_raw.stdout_lines | difference(kurento_ports) }}'

- set_fact:
    kurento_ip: "{% if bigbluebutton_kurento_use_internal_ip %}{{ ansible_default_ipv4.address }}{% else %}{{ external_ip }}{% endif %}"

- name: Determine kurento URLs to configure bbb-webrtc-sfu
  set_fact:
    kurento_config: "{{ kurento_config|default([]) + [ { 'ip': kurento_ip, 'url': 'ws://' + docker_ip + ':' + item + '/kurento' } ] }}"
  with_items: '{{ kurento_ports }}'

- name: Start kurento containers
  docker_container:
    name: kurento_{{ item }}
    image: '{{ bigbluebutton_docker_kurento_image }}'
    pull: yes
    restart_policy: unless-stopped
    network_mode: host
    # limit memory to avoid complete colapse
    memory: 1G
    volumes:
      - /var/kurento:/var/kurento
      - /var/log/kurento-media-server:/var/log/kurento-media-server
    env:
      PORT: '{{ item }}'
      RTP_MIN_PORT: '{{ bigbluebutton_kms_udp_range_begin | string }}'
      RTP_MAX_PORT: '{{ ( bigbluebutton_kms_udp_range_end - bigbluebutton_docker_mcs_bfcp_num_ports ) | string }}'
      KURENTO_LOGS_PATH: /var/log/kurento-media-server
      STUN_IP: '{{ stun_server_ip }}'
      STUN_PORT: '{{ stun_server_port }}'
      # GST_DEBUG: 'Kurento*:5,kms*:5'
    labels:
      hostname: '{{ inventory_hostname }}'
  with_items: '{{ kurento_ports }}'
  notify: restart docker components

- name: Remove old images
  shell: docker images {{ bigbluebutton_docker_kurento_image.split(":")[0] }} --filter 'before={{ bigbluebutton_docker_kurento_image }}' -q | xargs -r docker rmi --force
  notify: clean docker
