- name: Install docker compose
  become: true
  apt:
    name: docker-compose

- docker_service:
    project_src: mcs
    state: absent

- docker_service:
    project_name: mcs
    definition:
      version: '2'
      services:
        mcs-sip:
          image: mconf/mcs-sip:2.0.1-new-api
          pull: yes
          restart_policy: on-failure
          ports:
            - "5060:5060"
            - "5060:5060/udp"
          env:
            EXTERNAL_IP: '{{ external_ip }}'
            BIND_IP: 0.0.0.0
            MCS_PORT: 443
            MCS_HOST: '{{ inventory_hostname }}'
          depends_on:
            - sfu-phone
        sfu-phone:
          image: mconf/sfu-phone:mconf-2.x
          pull: yes
          restart_policy: on-failure
          ports:
            - "3011:3011"
          env:
            REDIS_HOST: '{{ docker_ip }}'
            MCS_PORT: 443
            MCS_ADDRESS: '{{ inventory_hostname }}'
          depends_on:
            - webrtc-sfu
        webrtc-sfu:
          image: mconf/bbb-webrtc-sfu:mconf-2.x
          pull: yes
          restart_policy: on-failure
          ports:
            - "3008:3008"
          env:
            KURENTO_URL: ws://{{ docker_ip }}:8888/kurento
            KURENTO_IP: '{{ external_ip }}'
            REDIS_HOST: '{{ docker_ip }}'
            MCS_PORT: 3009
            MCS_HOST: localhost
            FREESWITCH_IP: '{{ external_ip }}'
            LOG_LEVEL: trace
  register: output

- debug:
    var: output

- name: Add webrtc-sfu to nginx
  become: yes
  copy:
    src: files/webrtc-sfu.nginx
    dest: /etc/bigbluebutton/nginx/webrtc-sfu.nginx
  notify: reload nginx
