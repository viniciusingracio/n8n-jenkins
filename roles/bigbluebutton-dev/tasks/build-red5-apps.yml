- name: Stop red5
  service:
    name: red5
    state: stopped
  become: yes
  notify: restart bigbluebutton

- name: Change permissions over red5 webapps dir
  file:
    path: /var/lib/red5/webapps
    mode: 0777
    recurse: yes
    state: directory
  become: yes

- name: Set IP on bigbluebutton-sip.properties
  lineinfile:
    dest: '{{ ansible_env.HOME }}/dev/bigbluebutton/bbb-voice/src/main/webapp/WEB-INF/bigbluebutton-sip.properties'
    state: present
    regexp: '{{ item.regexp }}'
    line: '{{ item.line }}={{ ansible_default_ipv4.address }}'
  with_items:
    - { regexp: '^(bbb\.sip\.app\.ip)=', line: 'bbb.sip.app.ip' }
    - { regexp: '^(freeswitch\.ip)=', line: 'freeswitch.ip' }
  tags: [sip]

- name: Build red5 apps
  shell: |
    gradle resolveDeps
    gradle clean war deploy
  args:
    chdir: '{{ ansible_env.HOME }}/dev/bigbluebutton/{{ item }}'
  environment:
    PATH: '{{ ansible_env.HOME }}/dev/tools/gradle/bin:{{ ansible_env.PATH }}'
  with_items:
    - bbb-video
    - bbb-voice
    - bigbluebutton-apps
    - video-broadcast
