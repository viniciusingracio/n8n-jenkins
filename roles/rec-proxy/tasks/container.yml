- name: Download rec-proxy source code
  git:
    repo: '{{ rec_proxy_repo_url }}'
    dest: ~/src/rec-proxy
    version: '{{ rec_proxy_repo_ref }}'
    depth: 1 # just a snapshot
    accept_hostkey: true
    force: yes
  when: rec_proxy_build_from_source
  register: rec_proxy_code

# - name: Copy local rec-proxy source code
#   synchronize:
#     src: /home/leonardo/Dev/mconftec/mconf-rec-proxy/
#     dest: ~/src/rec-proxy
#   when: rec_proxy_build_from_source
#   register: rec_proxy_code

# TODO: remove old images
- name: Build the rec-proxy docker image
  docker_image:
    build_path: ~/src/rec-proxy/
    name: mconf/mconf-rec-proxy
    force: true
  when: rec_proxy_build_from_source and rec_proxy_code.changed

- name: Start the rec-proxy container
  docker_container:
    name: mconf-rec-proxy
    image: mconf/mconf-rec-proxy:latest
    restart_policy: unless-stopped
    volumes:
      - /var/log/nginx:/var/log/nginx
      - /var/www:/usr/share/nginx/html # for certbot --webroot and static pages
      - '{{ rec_proxy_cert_path_root }}:{{ rec_proxy_cert_path_root }}'
    published_ports:
      - 80:80
      - 443:443
    env:
      NGINX_HOST: '{{ rec_proxy_nginx_host }}'
      NGINX_CERT_PATH: '{{ rec_proxy_cert_path }}'
      NGINX_S3_URL: '{{ rec_proxy_nginx_s3_url }}'
