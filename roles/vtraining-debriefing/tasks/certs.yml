- name: Install openssl
  apt:
    name: openssl
    state: present
  become: yes

- name: Create certificate dir
  file:
    path: /etc/certs
    mode: 0755
    recurse: yes
    state: directory
  become: yes

- name: Generate key
  command: 'openssl genrsa -out {{ inventory_hostname }}.key 2048'
  become: yes
  args:
    chdir: /etc/certs
    creates: '/etc/certs/{{ inventory_hostname }}.key'
  notify: restart nginx

- name: Generate certificate
  command: 'openssl req -x509 -new -nodes -key {{ inventory_hostname }}.key -sha256 -days 3650 -out {{ inventory_hostname }}.crt -subj "/C=BR/ST=Porto Alegre/O=Mconf Tecnologia/OU=Dev/CN={{ inventory_hostname }}"'
  become: yes
  args:
    chdir: /etc/certs
    creates: '/etc/certs/{{ inventory_hostname }}.crt'
  notify: restart nginx

- name: Compare certificate before import
  command: 'diff -q /etc/certs/{{ inventory_hostname }}.crt /usr/local/share/ca-certificates/{{ inventory_hostname }}.crt'
  become: yes
  ignore_errors: yes
  register: diff_cert

- name: Copy certificate to be imported
  command: 'cp /etc/certs/{{ inventory_hostname }}.crt /usr/local/share/ca-certificates/'
  become: yes
  when: diff_cert is failed

- name: Import certificate
  command: update-ca-certificates --fresh
  become: yes
  when: diff_cert is failed
