---

- hosts: localhost
  tasks:
  - file:
      path: /tmp/recording-files
      state: directory

- hosts:
  - mconf-live220
  - mconf-rec
  - mconf-recw
  tasks:
  - name: Create initial list of directories to copy over
    copy:
      dest: /tmp/rec-files-to-rsync.txt
      content: |
        /var/bigbluebutton/published
        /var/bigbluebutton/unpublished
        /var/bigbluebutton/deleted


  - name: Copy files
    command: "rsync -azmr -e 'ssh -p {{ ansible_port }} {{ ansible_ssh_common_args }} -o StrictHostKeyChecking=no' --files-from=:/tmp/rec-files-to-rsync.txt {{ ansible_user }}@{{ inventory_hostname }}:/ /tmp/recording-files/"
    delegate_to: 127.0.0.1
    retries: 10
    delay: 2
    register: task_result
    until: task_result.rc == 0
