- hosts: postgresql
  roles:
    - role: geerlingguy.postgresql
      become: yes

- hosts: postgres_exporter
  roles:
    - docker-host
  tasks:
    - set_fact:
        user_list: '{{ postgresql_users | selectattr("name", "match", "^postgres_exporter$") | list }}'
    - fail:
        msg: "No postgres_exporter user defined"
      when: user_list | length == 0
    - set_fact:
        user: '{{ user_list | first}}'

    - set_fact:
        dbname: '{{ ( postgresql_databases | first )["name"] }}'

    - name: Start postgres exporter
      docker_container:
        name: postgres_exporter
        image: wrouesnel/postgres_exporter
        pull: yes
        restart_policy: always
        network_mode: host
        env:
          DATA_SOURCE_NAME: postgresql://{{ user["name"] }}:{{ user["password"] }}@localhost:5432/{{ dbname }}?sslmode=disable
        labels:
          hostname: '{{ inventory_hostname }}'

    - name: Start node-exporter
      docker_container:
        name: node-exporter
        image: quay.io/prometheus/node-exporter:v0.18.1
        command: --path.rootfs /host
        pull: yes
        restart_policy: always
        network_mode: host
        pid_mode: host
        volumes:
          - /:/host:ro,rslave
        labels:
          hostname: '{{ inventory_hostname }}'
